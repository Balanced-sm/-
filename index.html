<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áè≠‰∏ª‰ªªÊ®°ÊãüÂô® ¬∑ ÂçÅÂÖ≠Áè≠ÁöÑÊó•Â∏∏</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: #f0e6ff; 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .game-container {
            max-width: 1300px;
            width: 100%;
            background: #f3e9ff; 
            border-radius: 40px;
            box-shadow: 0 20px 40px rgba(120, 80, 200, 0.2);
            overflow: hidden;
            border: 2px solid rgba(200, 180, 255, 0.6);
            transition: background-color 0.5s ease;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: rgba(200, 180, 255, 0.7);
            backdrop-filter: blur(8px);
            color: #2a1b4a;
            padding: 20px 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid rgba(180, 140, 255, 0.5);
        }
        .header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            text-shadow: 0 0 8px #ffffff;
            letter-spacing: 1px;
        }
        .badge {
            background: #d9b3ff;
            color: #2a1b4a;
            padding: 8px 20px;
            border-radius: 60px;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 0 10px #c299ff;
        }
        .main-row {
            display: flex;
            flex-wrap: wrap;
        }
        .left-col {
            flex: 2;
            min-width: 350px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(4px);
            border-right: 1px solid rgba(200, 160, 255, 0.5);
        }
        .right-col {
            flex: 3;
            min-width: 500px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4,1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: rgba(255, 240, 255, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 24px;
            padding: 12px 10px;
            border: 1px solid rgba(180, 130, 255, 0.5);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #4a2b7a;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2a1b4a;
            text-shadow: 0 0 4px #ffffff;
        }
        .stat-value.warning {
            color: #b34a4a;
        }
        .status-bar {
            background: rgba(220, 200, 255, 0.7);
            backdrop-filter: blur(8px);
            padding: 15px 20px;
            border-radius: 60px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid #b38aff;
        }
        .status-item {
            background: rgba(200, 170, 255, 0.5);
            border-radius: 40px;
            padding: 8px 18px;
            font-size: 0.95rem;
            color: #2a1b4a;
            cursor: pointer;
            border: 1px solid #b38aff;
            transition: 0.2s;
            backdrop-filter: blur(4px);
        }
        .status-item:hover {
            background: #c299ff;
            border-color: white;
        }
        .event-area {
            background: rgba(255, 245, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #d9b3ff;
        }
        .event-title {
            font-size: 1.6rem;
            font-weight: 600;
            color: #2a1b4a;
            text-shadow: 0 0 5px #ffffff;
            margin-bottom: 10px;
        }
        .event-desc {
            color: #3a2b5a;
            line-height: 1.5;
            margin-bottom: 25px;
            font-size: 1rem;
        }
        .option-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .option-btn {
            background: rgba(200, 180, 255, 0.5);
            backdrop-filter: blur(8px);
            border: 1px solid #b38aff;
            border-radius: 60px;
            padding: 14px 20px;
            font-size: 1.1rem;
            text-align: left;
            color: #2a1b4a;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .option-btn:hover {
            background: #d9b3ff;
            border-color: white;
            transform: scale(1.02);
        }
        .option-btn:disabled {
            opacity: 0.3;
            pointer-events: none;
        }
        .log-area {
            background: rgba(255, 240, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 30px;
            padding: 15px 20px;
            color: #2a1b4a;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #b38aff;
            margin-bottom: 20px;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px dashed #a56eff;
        }
        .talent-view {
            background: rgba(255, 240, 255, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 30px;
            padding: 15px 20px;
            margin-bottom: 15px;
            border: 1px solid #d9b3ff;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .talent-view h4 {
            width: 100%;
            color: #2a1b4a;
            margin-bottom: 5px;
            font-size: 1.2rem;
        }
        .talent-tag, .achievement-tag {
            background: #c299ff;
            border-radius: 40px;
            padding: 6px 16px;
            color: #2a1b4a;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid #a56eff;
        }
        .talent-tag:hover, .achievement-tag:hover {
            background: #d9b3ff;
        }
        .detail-panel {
            background: rgba(255, 245, 255, 0.8);
            backdrop-filter: blur(12px);
            border-radius: 30px;
            padding: 15px 25px;
            border: 1px solid #d9b3ff;
            min-height: 100px;
        }
        .detail-title {
            font-weight: 600;
            color: #2a1b4a;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        .detail-content {
            color: #3a2b5a;
            font-size: 1rem;
            white-space: pre-wrap;
        }
        .control-bar {
            display: flex;
            gap: 15px;
            padding: 10px 20px 20px;
        }
        .btn {
            background: #b38aff;
            border: none;
            color: #2a1b4a;
            padding: 14px 30px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.2rem;
            flex: 1;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 0 15px #c299ff;
            border: 1px solid #d9b3ff;
        }
        .btn.secondary {
            background: #d9b3ff;
        }
        .btn:hover {
            background: #c299ff;
        }
        .select-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .select-row select, .select-row button {
            flex: 1 1 150px;
            padding: 12px;
            border-radius: 60px;
            border: 1px solid #b38aff;
            background: rgba(220, 200, 255, 0.7);
            color: #2a1b4a;
            font-size: 1rem;
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body>
<div class="game-container" id="gameContainer"></div>

<script>
(function() {
    // ---------- Â§©ËµãÂ∫ì ----------
    const TALENT_LIBRARY = [
        { id: 't1', name: 'ÁÅ´ÁúºÈáëÁùõ', desc: 'Á™ÅÂèëÊÅ∂ÊÄß‰∫ã‰ª∂Ê¶ÇÁéáÈôç‰Ωé20%', point: -2, type: 'pos' },
        { id: 't2', name: 'È∏°Ê±§Â§ßÂ∏à', desc: 'ÊØèÂë®Ëá™Âä®ÊÅ¢Â§ç2ÁÇπÂáùËÅöÂäõ', point: -1, type: 'pos' },
        { id: 't3', name: '‰∫∫ËÑâÁéã', desc: 'Â£∞ÊúõË°∞ÂáèÂáèÂçäÔºå10%Ê¶ÇÁéá+5Â£∞Êúõ', point: -3, type: 'pos' },
        { id: 't4', name: 'ÈáëÁâåË∞ÉËß£', desc: 'ÂáùËÅöÂäõ‰∫ã‰ª∂ÊïàÊûú+15%', point: -2, type: 'pos' },
        { id: 't5', name: 'ÂÅ•Â∫∑Âç´Â£´', desc: 'Âç´ÁîüË°∞ÂáèÈôç‰Ωé30%', point: -1, type: 'pos' },
        { id: 't6', name: 'Êó∂Èó¥ÁÆ°ÁêÜ', desc: 'ÊâÄÊúâ‰∫ã‰ª∂Á≤æÂäõÊ∂àËÄó-2', point: -2, type: 'pos' },
        { id: 't13', name: 'Á´ûËµõÊïôÁªÉ', desc: 'Á´ûËµõÁîüÂüπÂÖªÊïàÁéá+20%', point: -2, type: 'pos' },
        { id: 't14', name: 'Á§æÂõ¢‰πãÂèã', desc: 'Á§æÂõ¢Ê¥ªÂä®ÊïàÊûú+30%', point: -1, type: 'pos' },
        { id: 't16', name: 'ÂøÉÁêÜÁñèÂØºÂ∏à', desc: 'ÂøÉÁêÜÈóÆÈ¢ò‰∫ã‰ª∂ÊàêÂäüÁéá+20%', point: -2, type: 'pos' },
        { id: 't17', name: 'Ëá™ÊàëÂÖ≥ÊÄÄ', desc: 'Áè≠‰∏ª‰ªªÂøÉÁêÜÁä∂ÊÄÅÊÅ∂ÂåñÈÄüÂ∫¶ÂáèÂçä', point: -2, type: 'pos' },
        { id: 't7', name: 'ËÑ∏Áõ≤', desc: 'ÂáùËÅöÂäõË°∞Âáè+20%Ôºå‰∏™‰Ωì‰∫ã‰ª∂ÊàêÂäüÁéá-10%', point: 3, type: 'neg' },
        { id: 't8', name: 'ÊãñÂª∂Áóá', desc: 'Á≤æÂäõÊÅ¢Â§ç-10%ÔºåÁ™ÅÂèë‰∫ã‰ª∂Â§±Ë¥•+15%', point: 2, type: 'neg' },
        { id: 't9', name: 'ÂøÉÁõ¥Âè£Âø´', desc: 'ÂÆ∂Èïø‰∫ã‰ª∂Â£∞Êúõ‰∏ãÈôçÊ¶ÇÁéá+20%', point: 2, type: 'neg' },
        { id: 't10', name: 'ÂÆåÁæé‰∏ª‰πâ', desc: 'Á≤æÂäõÊ∂àËÄó+3ÔºåÁ∫™ÂæãÊïàÊûú+10%', point: 1, type: 'neg' },
        { id: 't11', name: 'ÊâãÊú∫‰æùËµñ', desc: '10%Ê¶ÇÁéáË∑≥Ëøá‰∫ã‰ª∂', point: 1, type: 'neg' },
        { id: 't12', name: 'ËÄÅÂ•Ω‰∫∫', desc: '30%È¢ùÂ§ñ‰∫ã‰ª∂ÔºåÁ≤æÂäõ‰∏äÈôê-10', point: 3, type: 'neg' },
        { id: 't15', name: 'Á´ûËµõÁÑ¶Ëôë', desc: 'Á´ûËµõÁîüÂéãÂäõÂ§ßÔºåÂáùËÅöÂäõ‰∏ãÈôç+10%', point: 2, type: 'neg' },
    ];

    const SEMESTERS = [
        { id: 'g1s1', label: 'È´ò‰∏Ä‰∏äÂ≠¶Êúü', grade: 0, season: '‰∏ä', weeks: 18, next: 'g1s2' },
        { id: 'g1s2', label: 'È´ò‰∏Ä‰∏ãÂ≠¶Êúü', grade: 0, season: '‰∏ã', weeks: 16, next: 'g2s1' },
        { id: 'g2s1', label: 'È´ò‰∫å‰∏äÂ≠¶Êúü', grade: 1, season: '‰∏ä', weeks: 18, next: 'g2s2' },
        { id: 'g2s2', label: 'È´ò‰∫å‰∏ãÂ≠¶Êúü', grade: 1, season: '‰∏ã', weeks: 16, next: 'g3s1' },
        { id: 'g3s1', label: 'È´ò‰∏â‰∏äÂ≠¶Êúü', grade: 2, season: '‰∏ä', weeks: 18, next: 'g3s2' },
        { id: 'g3s2', label: 'È´ò‰∏â‰∏ãÂ≠¶Êúü', grade: 2, season: '‰∏ã', weeks: 14, next: null }
    ];
    
    const CLASS_TYPES = {
        rocket: { name: 'ÁÅ´ÁÆ≠Áè≠', avgScore: 20, discipline: 10, cohesion: -5, rep: 0, hygiene: 0, allowSubjects: ['ËØ≠Êñá','Êï∞Â≠¶','Ëã±ËØ≠','Áâ©ÁêÜ','ÂåñÂ≠¶','ÁîüÁâ©'] },
        normal: { name: 'Âπ≥Ë°åÁè≠', avgScore: 0, discipline: 0, cohesion: 0, rep: 0, hygiene: 0, allowSubjects: ['ËØ≠Êñá','Êï∞Â≠¶','Ëã±ËØ≠','Áâ©ÁêÜ','ÂåñÂ≠¶','ÁîüÁâ©','ÂéÜÂè≤','ÊîøÊ≤ª','Âú∞ÁêÜ'] },
        art: { name: 'Ëâ∫ÊúØÁè≠', avgScore: -15, cohesion: 15, hygiene: 5, discipline: 0, rep: 0, allowSubjects: ['ËØ≠Êñá','Êï∞Â≠¶','Ëã±ËØ≠'] },
        contest: { name: 'Á´ûËµõÁè≠', avgScore: 30, discipline: -5, cohesion: -10, rep: 10, hygiene: -5, allowSubjects: ['Êï∞Â≠¶','Áâ©ÁêÜ'] }
    };
    
    const PERSONALITY = {
        strict: { name: '‰∏•ÂéâÂûã' }, gentle: { name: 'Ê∏©ÂíåÂûã' }, laidback: { name: 'ÊîæÂÖªÂûã' }
    };
    
    const DIFFICULTY = {
        easy: { name: 'ÁÆÄÂçï', pointRequire: -2, posEventMod: 1.1, negEventMod: 0.9 },
        normal: { name: 'ÊôÆÈÄö', pointRequire: 0, posEventMod: 1.0, negEventMod: 1.0 },
        hard: { name: 'Âõ∞Èöæ', pointRequire: 2, posEventMod: 0.9, negEventMod: 1.1 },
        reality: { name: 'Áé∞ÂÆûÊ®°Âºè', pointRequire: 0, posEventMod: 1.0, negEventMod: 1.0, reality: true }
    };
    
    // ---------- ‰∫ã‰ª∂Â∫ì ----------
    const BASE_EVENTS = [
        { id: 'e1', title: 'ÊôöËá™‰π†Áé©ÊâãÊú∫', desc: '‰Ω†Â∑°Áè≠Êó∂ÂèëÁé∞ÂêéÊéíÁöÑÂ∞èÁéãÊ≠£Âú®ÊâìÊ∏∏Êàè„ÄÇ', type: 'common',
          options: [
              { text: 'ÈìÅËÖïÊ≤°Êî∂', effects: { discipline: 8, rep: 5, cohesion: -5, energy: -8 } },
              { text: 'ÁßÅ‰∏ãË∞àËØù', effects: { discipline: 2, cohesion: 5, rep: 1, energy: -5 } },
              { text: 'ÂπΩÈªòÂåñËß£', personality: 'gentle', effects: { cohesion: 10, energy: -3, rep: -2 } }
          ]},
        { id: 'e2', title: 'ÊµÅÊÑüÁàÜÂèë', desc: 'Áè≠ÈáåÂçÅÂ§ö‰∏™Â≠¶ÁîüÊÑüÂÜíËØ∑ÂÅá„ÄÇ', type: 'common',
          options: [
              { text: 'ÂÖ®Èù¢Ê∂àÊØí', effects: { hygiene: 10, cohesion: 5, energy: -10, funds: -50 } }, // Áè≠Ë¥π
              { text: 'ÁÖßÂ∏∏‰∏äËØæ', effects: { avgScore: -3, hygiene: -5 } },
              { text: 'Áî≥ËØ∑ÁΩëËØæ', effects: { energy: -2, avgScore: -1, rep: 3 } }
          ]},
        { id: 'c1', title: 'Á´ûËµõÊä•Âêç', desc: 'Êï∞Â≠¶ËÅîËµõÂºÄÂßãÊä•Âêç„ÄÇ', type: 'contest',
          options: [
              { text: 'ÈºìÂä±ÂÖ®Âëò', effects: { avgScore: 2, cohesion: 5, energy: -6, funds: -30 } }, // Áè≠Ë¥π
              { text: 'Â∞ñÂ≠êÈõÜËÆ≠', effects: { avgScore: 5, cohesion: -2, energy: -10, funds: -60, rep: 8 } }, // Áè≠Ë¥π
              { text: '‰∏çÁªÑÁªá', effects: { cohesion: -3, rep: -2 } }
          ]},
        { id: 'c4', title: 'Á´ûËµõÁîüÈÄÄÂΩπ', desc: 'ÊúâÁ´ûËµõÁîüÂõ†ÂéãÂäõËøáÂ§ßÂÜ≥ÂÆöÈÄÄÂá∫„ÄÇ', type: 'contest',
          options: [
              { text: 'ÂøÉÁêÜÁñèÂØº', effects: { cohesion: 5, avgScore: -1, energy: -8 } },
              { text: 'ÈºìÂä±ÂùöÊåÅ', effects: { avgScore: 2, cohesion: -5, rep: 2 } },
              { text: 'Â∞äÈáçÂÜ≥ÂÆö', effects: { cohesion: 3, rep: 1, energy: -2 } }
          ]},
        // ËäÇÊó•‰∏éÂ≠£ËäÇ
        { id: 'hol1', title: '‰∏≠Áßã‰Ω≥ËäÇ', desc: 'Â≠¶Ê†°Âèë‰∫Ü‰∏ÄÁ¨îÊúàÈ•ºÁªèË¥πÔºå‰ΩÜ‰∏çÂ§üÊØè‰∫∫‰∏Ä‰ªΩ„ÄÇ', type: 'holiday',
          options: [
              { text: 'Ëá™Â∑±Ë°•Èí±', effects: { cohesion: 15, rep: 10, personalFunds: -100 } }, // ‰∏™‰∫∫ËµÑ‰∫ß
              { text: 'Êå™Áî®Áè≠Ë¥π', effects: { cohesion: 8, rep: 3, funds: -80 } }, // Áè≠Ë¥π
              { text: 'Âè™ÂèëÈÉ®ÂàÜ', effects: { cohesion: -10, rep: -5 } },
              { text: 'Âπ≤ËÑÜÂÖ®ÂΩíÊàë‰∫Ü', effects: { personalFunds: 200, funds: -200, rep: -20, cohesion: -15 } } // ‰∏™‰∫∫ÂæóÈí±ÔºåÁè≠Ë¥πÊçüÂ§±
          ]},
        { id: 'hol2', title: 'ÂÖÉÊó¶Êôö‰ºö', desc: 'Â≠¶Ê†°Ë¶ÅÊ±ÇÊØè‰∏™Áè≠ÂáÜÂ§áËäÇÁõÆ„ÄÇ', type: 'holiday',
          options: [
              { text: 'Á≤æÂøÉÁªÑÁªá', effects: { cohesion: 20, rep: 15, energy: -20, funds: -150 } }, // Áè≠Ë¥π
              { text: 'ÁÆÄÂçïÂ∫î‰ªò', effects: { cohesion: 5, rep: 2, energy: -5 } },
              { text: '‰∏çÂèÇÂä†', effects: { rep: -15, cohesion: -10 } },
              { text: 'Ëä±Èí±ËØ∑Â§ñÊè¥', effects: { cohesion: 10, rep: 5, funds: -200, personalFunds: 100 } } // Áè≠Ë¥πÊîØÂá∫Ôºå‰∏™‰∫∫Ë¥™Ê±°
          ]},
        { id: 'hol3', title: 'Ê∏ÖÊòéÁ•≠Êâ´', desc: 'ÁªÑÁªáÂ≠¶ÁîüÂéªÁÉàÂ£´ÈôµÂõ≠Êâ´Â¢ì„ÄÇ', type: 'holiday',
          options: [
              { text: 'ËÆ§ÁúüÁªÑÁªá', effects: { rep: 20, cohesion: 15, energy: -15, funds: -80 } }, // Áè≠Ë¥π
              { text: 'Ëµ∞ÂΩ¢Âºè', effects: { rep: 5, cohesion: 2, energy: -5 } },
              { text: '‰∏çÁªÑÁªá', effects: { rep: -10 } }
          ]},
        { id: 'hol4', title: 'Êò•ËäÇÊãúÂπ¥', desc: 'Âá†ÂêçÂ≠¶ÁîüÊù•‰Ω†ÂÆ∂ÊãúÂπ¥„ÄÇ', type: 'holiday',
          options: [
              { text: 'ÁÉ≠ÊÉÖÊãõÂæÖ', effects: { cohesion: 15, rep: 10, personalFunds: -50, energy: -5 } }, // ‰∏™‰∫∫
              { text: 'ÁÆÄÂçïÂõûÁ§º', effects: { cohesion: 5, rep: 3, personalFunds: -10 } }, // ‰∏™‰∫∫
              { text: 'ÈÅøËÄå‰∏çËßÅ', effects: { cohesion: -10, rep: -5 } }
          ]},
        { id: 'hol5', title: 'ÂÜ¨Ëá≥ÂåÖÈ•∫Â≠ê', desc: 'Áè≠Á∫ßÁªÑÁªáÂåÖÈ•∫Â≠êÊ¥ªÂä®„ÄÇ', type: 'holiday',
          options: [
              { text: 'Ëá™Â∑±Âá∫Èí±', effects: { cohesion: 15, rep: 8, personalFunds: -60, energy: -10 } }, // ‰∏™‰∫∫
              { text: 'Áî®Áè≠Ë¥π', effects: { cohesion: 10, rep: 5, funds: -80, energy: -10 } }, // Áè≠Ë¥π
              { text: 'Ë±°ÂæÅÊÄßÊêû', effects: { cohesion: 3, energy: -3 } },
              { text: 'ÂÄüÊú∫Ë¥™Ê±°Áè≠Ë¥π', effects: { personalFunds: 30, funds: -50, cohesion: -5, rep: -3 } } // ‰∏™‰∫∫ÂæóÔºåÁè≠Ë¥πÂ§±
          ]},
        // Â≠£ËäÇÂâßÊÉÖ
        { id: 'sea1', title: 'ÁßãÈõ®ËøûÁªµ', desc: 'ËøûÊó•ÁöÑÈò¥Èõ®ËÆ©Â≠¶Áîü‰ª¨ÊÉÖÁª™‰ΩéËêΩ„ÄÇ', type: 'season',
          options: [
              { text: 'ÁªÑÁªáÂÆ§ÂÜÖÊ¥ªÂä®', effects: { cohesion: 8, energy: -8, funds: -30 } }, // Áè≠Ë¥π
              { text: 'ÂøÉÁêÜÁñèÂØº', effects: { cohesion: 5, energy: -10 } },
              { text: '‰∏çÁÆ°', effects: { cohesion: -5, avgScore: -2 } }
          ]},
        { id: 'sea2', title: 'ÂàùÈõ™Èôç‰∏¥', desc: 'Á¨¨‰∏ÄÂú∫Èõ™ÔºåÂ≠¶Áîü‰ª¨Êó†ÂøÉÂ≠¶‰π†„ÄÇ', type: 'season',
          options: [
              { text: 'ÂÖÅËÆ∏ËØæÈó¥Áé©Èõ™', effects: { cohesion: 12, discipline: -5 } },
              { text: 'Âº∫Ë∞ÉÁ∫™Âæã', effects: { discipline: 5, cohesion: -3 } },
              { text: 'ÁªÑÁªáÊâ´Èõ™', effects: { hygiene: 8, cohesion: 5, energy: -12 } } // Êó†ËµÑÈáëÂèòÂåñ
          ]},
        { id: 'sea3', title: 'Êò•Ê∏∏Ë∏èÈùí', desc: 'Êò•Â§©ÈÄÇÂêàÊò•Ê∏∏ÔºåÂ≠¶Ê†°ÈºìÂä±Áè≠Á∫ßÊ¥ªÂä®„ÄÇ', type: 'season',
          options: [
              { text: 'Á≤æÂøÉÁªÑÁªá', effects: { cohesion: 15, rep: 10, funds: -100, energy: -15 } }, // Áè≠Ë¥π
              { text: 'ÁÆÄÂçïÈáéÈ§ê', effects: { cohesion: 8, funds: -30, energy: -8 } }, // Áè≠Ë¥π
              { text: '‰∏çÂèÇÂä†', effects: { cohesion: -8 } }
          ]},
        { id: 'sea4', title: 'Â§èÂ§úËùâÈ∏£', desc: 'Èó∑ÁÉ≠ÁöÑÂ§úÊôöÔºåÂ≠¶ÁîüÊµÆË∫Å„ÄÇ', type: 'season',
          options: [
              { text: '‰π∞ÂÜ∞Ê£çÈôçÊ∏©', effects: { cohesion: 10, funds: -50, energy: -5 } }, // Áè≠Ë¥π
              { text: 'Âª∂ÈïøÊôöËá™‰π†', effects: { avgScore: 3, cohesion: -5 } },
              { text: 'ÊîæÂÅáÂçäÂ§©', effects: { energy: 15, avgScore: -2 } }
          ]},
        { id: 'misc1', title: 'Áè≠Ë¥πÁü≠Áº∫', desc: 'Áè≠Ë¥π‰∏çÂ§ü‰π∞ËøêÂä®‰ºöÁâ©ËµÑ„ÄÇ', type: 'moral',
          options: [
              { text: 'Ëá™Â∑±Ë°•Ë¥¥', effects: { cohesion: 10, rep: 8, personalFunds: -100, funds: 100 } }, // ‰∏™‰∫∫ËΩ¨Áè≠Ë¥π
              { text: 'Âπ≤ËÑÜÂà´‰π∞‰∫ÜÔºåËøôÈí±ÂΩíÊàë‰∏çÂ∞±Ë°å‰∫Ü', effects: { personalFunds: 100, funds: -100, rep: -15, cohesion: -5 } }, // ‰∏™‰∫∫ÂæóÔºåÁè≠Ë¥πÂ§±
              { text: 'ÂêëÂ≠¶Ê†°Áî≥ËØ∑', effects: { rep: 5, energy: -10, funds: 50 } }
          ]},
        // Â≠¶ÁîüÂøÉÁêÜÁ≤æÁ•ûÈóÆÈ¢ò
            { id: 'p1', title: 'Â≠¶ÁîüÂøÉÁêÜÂç±Êú∫', desc: '‰∏ÄÂêçÂ≠¶ÁîüËøëÊúüÊÉÖÁª™‰ΩéËêΩÔºåÂá∫Áé∞Ëá™ÊàëÊÄÄÁñëÔºåÂèØËÉΩÈúÄË¶Å‰∏ì‰∏öÂπ≤È¢Ñ„ÄÇ', type: 'psych',
              options: [
                  { text: 'ËÅîÁ≥ªÂøÉÁêÜÂí®ËØ¢Â∏à', effects: { cohesion: 5, rep: 5, energy: -10, funds: -50 } }, // Áè≠Ë¥π
                  { text: 'ÁßÅ‰∏ãË∞àÂøÉ', effects: { cohesion: 8, energy: -12 }, psych: true },
                  { text: 'ÈÄöÁü•ÂÆ∂Èïø', effects: [ { cohesion: 3, rep: 2, energy: -5 }, { cohesion: -10, rep: -5, avgScore: -3 } ] },
                  { text: 'ÂøΩËßÜ', effects: { cohesion: -15, avgScore: -5, rep: -5 } }
              ]},
            { id: 'p2', title: 'Á≤æÁ•ûÁñæÁóÖËãóÂ§¥', desc: 'ÊúâÂ≠¶ÁîüÂá∫Áé∞Âº∫Ëø´ÁóáÁä∂ÔºåÈ¢ëÁπÅÊ¥óÊâãÔºåÂΩ±ÂìçÂ≠¶‰π†„ÄÇ', type: 'psych',
              options: [
                  { text: 'Âª∫ËÆÆÂ∞±Âåª', effects: { cohesion: 2, rep: 3, energy: -10, funds: -30 } }, // Áè≠Ë¥π
                  { text: 'ÂÆâÊéíÂøÉÁêÜËæÖÂØº', effects: { cohesion: 5, energy: -8 } },
                  { text: '‰∏•ÂéâÊâπËØÑ', effects: { discipline: 3, cohesion: -20, rep: -5 } }
              ]},
            { id: 'p3', title: 'ÁÑ¶ËôëËîìÂª∂', desc: 'ËÄÉËØï‰∏¥ËøëÔºåÁè≠ÈáåÂº•Êº´ÁùÄÁÑ¶ËôëÊÉÖÁª™ÔºåÂ≠¶ÁîüÂ§±Áú†Â¢ûÂ§ö„ÄÇ', type: 'psych',
              options: [
                  { text: 'ÂºÄÂ±ïÂáèÂéãËÆ≤Â∫ß', effects: { cohesion: 10, avgScore: 2, energy: -10, funds: -20 } }, // Áè≠Ë¥π
                  { text: '‰∏™Âà´Ë∞àËØù', effects: { cohesion: 5, energy: -15 } },
                  { text: 'Âä†Âº∫ËÄÉËØïËÆ≠ÁªÉ', effects: { avgScore: 5, cohesion: -10, rep: 2 } }
              ]},
            { id: 'p4', title: 'ÊäëÈÉÅÂÄæÂêë', desc: '‰∏ÄÂêçÂ≠¶ÁîüÁ™ÅÁÑ∂‰∏ßÂ§±Â≠¶‰π†ÂÖ¥Ë∂£ÔºåÂØ°Ë®ÄÂ∞ëËØ≠„ÄÇ', type: 'psych',
              options: [
                  { text: '‰∏ì‰∏öÂøÉÁêÜÂπ≤È¢Ñ', effects: { cohesion: 5, rep: 5, energy: -15, funds: -100 } }, // Áè≠Ë¥π
                  { text: 'ËÄêÂøÉÈô™‰º¥', effects: { cohesion: 12, energy: -20, avgScore: -2 } },
                  { text: 'ÊöÇÁºìÂ≠¶‰∏ö', effects: { cohesion: 3, avgScore: -5, rep: -2 } }
              ]},
            { id: 'p5', title: 'Á§æ‰∫§ÊÅêÊÉß', desc: 'ÊúâÂ≠¶ÁîüÂÆ≥ÊÄïÈõÜ‰ΩìÊ¥ªÂä®ÔºåÊÄªÊòØÁã¨Êù•Áã¨ÂæÄ„ÄÇ', type: 'psych',
              options: [
                  { text: 'ÂÆâÊéíÂêåÂ≠¶‰∫íÂä©', effects: { cohesion: 8, energy: -6 } },
                  { text: 'ÈºìÂä±ÂèÇÂä†Á§æÂõ¢', effects: { cohesion: 5, rep: 2, energy: -4 } },
                  { text: 'È°∫ÂÖ∂Ëá™ÁÑ∂', effects: { cohesion: -5 } }
              ]},
            { id: 'p6', title: 'ÊâãËáÇ‰∏äÁöÑ‰º§Áóï', desc: '‰Ω†ÂèëÁé∞Â≠¶ÁîüÂ∞èÊûóÊâãËáÇ‰∏äÊúâÂá†ÈÅìÊñ∞ÁöÑÂàíÁóïÔºåÁñë‰ººËá™ÊÆãË°å‰∏∫„ÄÇ', type: 'psych',
              options: [
                  { text: 'Á´ãÂç≥ËÅîÁ≥ªÂøÉÁêÜËÄÅÂ∏à', effects: { cohesion: 10, rep: 8, energy: -12, funds: 0 } },
                  { text: 'ÁßÅ‰∏ãÊ∏©ÊüîËØ¢ÈóÆ', effects: { cohesion: 8, energy: -15 }, psych: true },
                  { text: 'ÈÄöÁü•ÂÆ∂ÈïøÂπ∂Âª∫ËÆÆÂ∞±Âåª', effects: [ { cohesion: 5, rep: 5, avgScore: -1, energy: -10 }, { cohesion: -15, rep: -8, avgScore: -5, energy: -5 } ] },
                  { text: 'ÂÅáË£ÖÊ≤°ÁúãËßÅ', effects: { cohesion: -30, avgScore: -10, rep: -15 } },
                  { text: 'ÂΩì‰ºóÊñ•Ë¥£', effects: { discipline: 5, cohesion: -40, avgScore: -8, rep: -20 } }
              ]},
            { id: 'p7', title: 'Ê¥ªÁùÄÊ≤°ÊÑèÊÄù', desc: 'Â≠¶ÁîüÂ∞èÈôàÂú®‰ΩúÊñá‰∏≠ÊµÅÈú≤Âá∫Ê∂àÊûÅÂéå‰∏ñÁöÑÊÉÖÁª™Ôºå‰Ω†ËØªÂêéÂçÅÂàÜÊãÖÂøß„ÄÇ', type: 'psych',
              options: [
                  { text: 'Á¥ßÊÄ•ËÅîÁ≥ªÂøÉÁêÜËÄÅÂ∏à', effects: { cohesion: 12, rep: 10, energy: -15, funds: 0 } },
                  { text: 'Á∫¶Ë∞àÂÆ∂Èïø', effects: [ { cohesion: 4, rep: 3, energy: -8 }, { cohesion: -12, rep: -6, avgScore: -2 } ] },
                  { text: 'ÈªòÈªòÊåÅÁª≠ÂÖ≥Ê≥®', effects: { cohesion: 2, energy: -5 } },
                  { text: 'ÊâπËØÑ‰ΩúÊñáÂÜÖÂÆπ', effects: { avgScore: 2, cohesion: -20, rep: -10 } }
              ]},
            // Áè≠‰∏ª‰ªªÂøÉÁêÜÈóÆÈ¢ò‰∫ã‰ª∂
            { id: 'tch1', title: 'ËÅå‰∏öÂÄ¶ÊÄ†', desc: 'ÈïøÊúüÈ´òÂéãÂ∑•‰ΩúËÆ©‰Ω†ÊÑüÂà∞Áñ≤ÊÉ´È∫ªÊú®ÔºåÂØπÂ≠¶ÁîüÂ§±ÂéªËÄêÂøÉ„ÄÇ', type: 'teacher',
              options: [
                  { text: 'ËØ∑ÂÅá‰ºëÊÅØ', effects: { energy: 30, avgScore: -3, discipline: -2, cohesion: -2, rep: -2 } },
                  { text: 'ÂØªÊ±ÇÂêå‰∫ãÊîØÊåÅ', effects: { energy: 10, cohesion: 5, rep: 2 } },
                  { text: 'Á°¨Êíë', effects: { energy: -20, cohesion: -5, avgScore: -2 } },
                  { text: 'ÂêëÂ≠¶ÁîüÂèëÊ≥ÑÊÉÖÁª™', effects: { energy: 5, cohesion: -20, rep: -15, avgScore: -5 } }
              ], teacherStateEffect: 'burnout'},
            { id: 'tch2', title: 'ÁÑ¶ËôëÂèë‰Ωú', desc: '‰Ω†Á™ÅÁÑ∂ÊÑüÂà∞ÂøÉÊÖåÊâãÊäñÔºåÈöæ‰ª•ÈõÜ‰∏≠Á≤æÂäõÂ∑•‰Ωú„ÄÇ', type: 'teacher',
              options: [
                  { text: 'ÁúãÂåªÁîü', effects: { energy: 20, personalFunds: -100, avgScore: -2 } }, // ‰∏™‰∫∫
                  { text: 'Ëá™ÊàëË∞ÉËäÇ', effects: { energy: 5, cohesion: 3 } },
                  { text: 'ÁªßÁª≠Â∑•‰Ωú', effects: { energy: -15, avgScore: -3, discipline: -2 } }
              ], teacherStateEffect: 'stressed'},
            { id: 'tch3', title: 'Â§±Áú†Âõ∞Êâ∞', desc: '‰Ω†Â∑≤ÁªèËøûÁª≠‰∏ÄÂë®Â§±Áú†ÔºåÁôΩÂ§©Á≤æÁ•ûÊÅçÊÉö„ÄÇ', type: 'teacher',
              options: [
                  { text: 'Â∞±Âåª', effects: { energy: 25, personalFunds: -80, avgScore: -1 } }, // ‰∏™‰∫∫
                  { text: 'ÂñùÂíñÂï°Á°¨Êíë', effects: { energy: 5, avgScore: -2, cohesion: -3 } },
                  { text: 'ËØ∑ÂÅáË°•Ëßâ', effects: { energy: 40, avgScore: -4, discipline: -2 } }
              ], teacherStateEffect: 'tired'},
            { id: 'tch4', title: 'ÊäëÈÉÅÊÉÖÁª™', desc: '‰Ω†ÂºÄÂßãÊÄÄÁñëËá™Â∑±ÂΩìÁè≠‰∏ª‰ªªÁöÑÊÑè‰πâÔºåÊÉÖÁª™ÊåÅÁª≠‰ΩéËêΩ„ÄÇ', type: 'teacher',
              options: [
                  { text: 'ÂØªÊ±ÇÂøÉÁêÜÂí®ËØ¢', effects: { energy: 15, cohesion: 8, rep: 2, personalFunds: -150 } }, // ‰∏™‰∫∫
                  { text: '‰∏éÂÆ∂‰∫∫ÂÄæËØâ', effects: { energy: 10, cohesion: 5 } },
                  { text: 'Áã¨Ëá™ÊâøÂèó', effects: { energy: -20, cohesion: -10, avgScore: -5 } },
                  { text: 'Êó†ÊïÖÊâπËØÑÂ≠¶Áîü', effects: { energy: 5, cohesion: -25, rep: -15, avgScore: -3 } }
              ], teacherStateEffect: 'depressed'},
            { id: 'm1', title: 'Â≠¶ÁîüÈ°∂Êíû', desc: 'Â≠¶ÁîüÂ∞èÊùéÂú®ËØæÂ†Ç‰∏äÂÖ¨ÂºÄÈ°∂Êíû‰Ω†ÔºåËÆ©‰Ω†‰∏ã‰∏çÊù•Âè∞„ÄÇ', type: 'moral',
              options: [
                  { text: 'ÂÜ∑ÈùôÊ≤üÈÄö', effects: { discipline: 5, cohesion: 3, rep: 2, energy: -5 } },
                  { text: 'ËØ∑ÂÆ∂Èïø', effects: [ { discipline: 8, cohesion: -2, rep: 3, energy: -6 }, { discipline: 2, cohesion: -10, rep: -5, energy: -8 } ] },
                  { text: 'ÁΩöÁ´ôÂπ∂ËÆ≠Êñ•', effects: { discipline: 10, cohesion: -15, rep: -3, energy: -3 } },
                  { text: '‰∫ãÂêéË∞àÂøÉ', effects: { cohesion: 10, rep: 5, avgScore: 1, energy: -10 } }
              ]},
            { id: 'm2', title: 'Â≠¶ÁîüÂøòÂ∏¶‰Ωú‰∏ö', desc: 'ËØæ‰ª£Ë°®Â∞èËµµÂøòÂ∏¶‰Ωú‰∏öÔºåËß£ÈáäËØ¥Êò®ÊôöÂÆ∂ÈïøÂêµÊû∂Ê≤°È°æ‰∏ä„ÄÇ', type: 'moral',
              options: [
                  { text: 'ÊåâËßÑÂÆöÊâ£ÂàÜ', effects: { discipline: 3, cohesion: -2, rep: 0 } },
                  { text: 'Ë∞ÖËß£‰∏ÄÊ¨°', effects: { cohesion: 5, discipline: -2 } },
                  { text: 'ÂΩì‰ºóÁæûËæ±', effects: { discipline: 5, cohesion: -20, rep: -5, avgScore: -2 } },
                  { text: 'ÁßÅ‰∏ãÂÆâÊÖ∞Âπ∂Ë°•ÂÅö', effects: { cohesion: 8, avgScore: 2, energy: -4 } }
              ]},
            { id: 'm3', title: 'Â≠¶ÁîüËØ∑ÁóÖÂÅá', desc: 'ÊúâÂ≠¶ÁîüÊãøÁùÄÁóÖÂÅáÊù°ËØ∑ÂÅáÔºå‰ΩÜ‰Ω†ÊÄÄÁñëÂèØËÉΩÊòØÂÅáÁöÑ„ÄÇ', type: 'moral',
              options: [
                  { text: 'ÂáÜÂÅá', effects: { cohesion: 3, rep: 2 } },
                  { text: 'ÊâìÁîµËØùÊ†∏ÂÆû', effects: [ { rep: 2, energy: -4, cohesion: 1 }, { rep: -3, cohesion: -5, avgScore: -1 } ] },
                  { text: 'ÂΩìÂú∫Êè≠Á©ø', effects: { discipline: 5, cohesion: -15, rep: -8 } },
                  { text: 'ÊâπÂáÜÂπ∂ÂÖ≥ÂøÉ', effects: { cohesion: 8, rep: 5, energy: -2 } }
              ]},
            { id: 'm4', title: 'Â≠¶ÁîüÊàêÁª©‰∏ãÊªë', desc: '‰∏ÄÂêçÂπ≥Êó∂ËÆ§ÁúüÁöÑÂ≠¶ÁîüËøëÊúüÊàêÁª©‰∏ãÊªëÔºå‰Ω†‰∫ÜËß£Âà∞‰ªñÂÆ∂ÈáåÊúâÂèòÊïÖ„ÄÇ', type: 'moral',
              options: [
                  { text: '‰∏•ÂéâÊâπËØÑ', effects: { avgScore: -2, discipline: 5, cohesion: -10 } },
                  { text: 'Ë∞àÂøÉÈºìÂä±', effects: { cohesion: 10, avgScore: 3, energy: -8 } },
                  { text: 'ÂΩì‰ºóÁÇπÂêç', effects: { avgScore: -5, cohesion: -15, rep: -5 } },
                  { text: 'ËÅîÁ≥ªÂøÉÁêÜËÄÅÂ∏àÂ∏ÆÊâ∂', effects: { cohesion: 8, rep: 5, avgScore: 2, energy: -6, funds: -20 } } // Áè≠Ë¥π
              ]},
            { id: 'm5', title: 'Â≠¶ÁîüÊÉÖÁª™Â¥©Ê∫É', desc: 'ËØæÈó¥‰∏ÄÂêçÂ•≥ÁîüÁ™ÅÁÑ∂Â§ßÂì≠ÔºåËØ¥ÂéãÂäõÂ§™Â§ßÂèó‰∏ç‰∫Ü„ÄÇ', type: 'moral',
              options: [
                  { text: 'ÂÆâÊÖ∞Â•π', effects: { cohesion: 10, energy: -6 } },
                  { text: 'ËØ∑ÂøÉÁêÜËÄÅÂ∏à', effects: { cohesion: 12, rep: 5, energy: -8, funds: -30 } }, // Áè≠Ë¥π
                  { text: 'ËÆ©Â•πÂÜ∑ÈùôÂà´ÂΩ±ÂìçÂà´‰∫∫', effects: { cohesion: -20, rep: -10, avgScore: -2 } },
                  { text: 'ÈÄöÁü•ÂÆ∂ÈïøÊé•Âõû', effects: [ { cohesion: 5, rep: 3, energy: -4 }, { cohesion: -8, rep: -5, avgScore: -2 } ] }
              ]}
    ];
    
    const EXAM_EVENTS = [
        { id: 'exam1', title: 'Êúü‰∏≠ËÄÉËØï', desc: 'Êúü‰∏≠ËÄÉËØïÁªìÊùü‰∫Ü„ÄÇ', options: [
            { text: 'ÂàÜÊûêÈºìÂä±', effects: { avgScore: 3, cohesion: 5, rep: 3, energy: -8 } },
            { text: 'Âè™Ë°®Êâ¨Ââç‰∏â', effects: { avgScore: 1, cohesion: -3, rep: 2 } },
            { text: 'ÊîæÂÅáÊîæÊùæ', effects: { cohesion: 8, avgScore: -2, energy: 5 } }
        ]},
        { id: 'exam2', title: 'ÊúüÊú´ËÄÉËØï', desc: 'ÊúüÊú´ËÄÉËØïÁªìÊùü„ÄÇ', options: [
            { text: 'Ë°®ÂΩ∞‰ºö', effects: { cohesion: 8, rep: 5, avgScore: 2, energy: -5 } },
            { text: 'Â∏ÉÁΩÆ‰Ωú‰∏ö', effects: { avgScore: 3, cohesion: -2, rep: 2 } },
            { text: 'ÊèêÂâçÊîæÂ≠¶', effects: { cohesion: 5, avgScore: -2, rep: -3 } }
        ]},
    ];
    
    const WEEKEND_ACTIVITIES = [
        { name: 'Á§æÂõ¢Ê¥ªÂä®', effects: { cohesion: 6, energy: -8, funds: -20 } }, // Áè≠Ë¥π
        { name: 'ËæÖÂØºÁ´ûËµõ', effects: { avgScore: 4, energy: -10, cohesion: 2 } }, // Êó†ËµÑÈáëÂèòÂåñ (‰∏™‰∫∫‰ªòÂá∫Á≤æÂäõ)
        { name: 'ÂÆ∂ËÆø', effects: [ { rep: 5, cohesion: 3, energy: -8, personalFunds: -20 }, { rep: -3, cohesion: -5, energy: -10, personalFunds: -10 } ] }, // ‰∏™‰∫∫ËµÑ‰∫ß
        { name: 'Âë®Êú´Ëá™‰π†', effects: { avgScore: 3, discipline: 4, energy: -6 } }, // Êó†ËµÑÈáë
        { name: '‰ºëÊÅØ', effects: { energy: 10 } },
    ];
    
    const VACATION_EVENTS = {
        winter: [
            { title: 'ÂØíÂÅá‰Ωú‰∏ö', desc: '‰Ωú‰∏öÂÆåÊàêÂ∫¶‰∏ÄËà¨„ÄÇ', options: [
                { text: 'Á∫ø‰∏äÁù£‰øÉ', effects: { avgScore: 2, energy: -4 } },
                { text: 'È°∫ÂÖ∂Ëá™ÁÑ∂', effects: { avgScore: -1 } }
            ]},
            { title: 'Êò•ËäÇÊãúÂπ¥', desc: 'ÊòØÂê¶ÂÆ∂ËÆøÔºü', options: [
                { text: 'Ëµ∞ËÆø', effects: [ { cohesion: 5, rep: 5, personalFunds: -30 }, { cohesion: -2, rep: -5, personalFunds: -20 } ] }, // ‰∏™‰∫∫
                { text: 'ÁîµËØù', effects: { cohesion: 2, rep: 2, energy: -2 } }
            ]},
            { title: 'ÂÅáÊúüÁúãÁóÖ', desc: '‰Ω†ÁîüÁóÖ‰∫Ü„ÄÇ', options: [
                { text: '‰ºëÂÖª', effects: { energy: 20, avgScore: -2, cohesion: 2 } },
                { text: 'Â∏¶ÁóÖÂ∑•‰Ωú', effects: { energy: -15, avgScore: 2, rep: 3 } }
            ]}
        ],
        summer: [
            { title: 'Á§æ‰ºöÂÆûË∑µ', desc: 'ÁªÑÁªáÂÖ¨ÁõäÊ¥ªÂä®„ÄÇ', options: [
                { text: 'ÁßØÊûÅ', effects: { cohesion: 8, rep: 5, funds: -60, energy: -12 } }, // Áè≠Ë¥π
                { text: 'Ëá™Áî±ÂèÇÂä†', effects: { cohesion: 2 } }
            ]},
            { title: 'ÁΩëÂêßÊ≤âËø∑', desc: 'Â≠¶ÁîüÂ∏∏ÂéªÁΩëÂêß„ÄÇ', options: [
                { text: 'Ë≠¶Âëä', effects: { discipline: 5, cohesion: -3, energy: -5 } },
                { text: 'ËÅîÁ≥ªÂÆ∂Èïø', effects: [ { rep: 4, cohesion: 2, energy: -6 }, { rep: -5, cohesion: -8, energy: -8 } ] }
            ]},
            { title: 'ÂÅáÊúüÁúãÁóÖ', desc: '‰Ω†ÁîüÁóÖ‰∫Ü„ÄÇ', options: [
                { text: '‰ºëÂÖª', effects: { energy: 20, avgScore: -2, cohesion: 2 } },
                { text: 'Â∏¶ÁóÖÂ∑•‰Ωú', effects: { energy: -15, avgScore: 2, rep: 3 } }
            ]}
        ]
    };
    
    const LOW_STAT_EVENTS = [
        { id: 'low1', title: 'Á≤æÂäõÈÄèÊîØ', desc: '‰Ω†ÁóÖÂÄí‰∫ÜÔºåÈúÄË¶Å‰ºëÊÅØ‰∏ÄÂë®„ÄÇ', stat: 'energy', threshold: 0,
          options: [ { text: 'Âº∫Âà∂‰ºëÊÅØ', effects: { energy: 30, avgScore: -5, cohesion: -3, rep: -2 }, skipWeek: true } ] },
        { id: 'low2', title: 'Á∫™ÂæãÂ¥©Âùè', desc: 'Áè≠Á∫ßË¢´ÈÄöÊä•ÊâπËØÑ„ÄÇ', stat: 'discipline', threshold: 15,
          options: [ { text: 'Êï¥È°ø', effects: { discipline: 10, energy: -15, cohesion: -3 } } ] },
    ];
    
    const BASE_STATS = {
        avgScore: 50, discipline: 50, hygiene: 50, cohesion: 50, rep: 50, funds: 200, personalFunds: 500,
        energy: 100, maxEnergy: 100
    };
    
    const PLAYER_STATE_EFFECTS = {
        tired: { name: 'Áñ≤ÊÉ´', desc: 'Á≤æÂäõÊÅ¢Â§ç-5/Â±Ç' },
        stressed: { name: 'ÂéãÂäõÂ§ß', desc: 'ÂøÉÁêÜ‰∫ã‰ª∂Ê¶ÇÁéá+20%/Â±Ç' },
        burnout: { name: 'ËÅå‰∏öÂÄ¶ÊÄ†', desc: '‰∫ã‰ª∂ÊïàÊûú-10%/Â±ÇÔºåÁ≤æÂäõÊÅ¢Â§ç-10/Â±Ç' },
        depressed: { name: 'ÊäëÈÉÅÂÄæÂêë', desc: 'ÊØèÂë®Ëá™Âä®-5Á≤æÂäõ/Â±ÇÔºå-3ÂáùËÅöÂäõ/Â±Ç' }
    };
    
    // ËÉåÊôØËâ≤ÂáΩÊï∞
    function getBackgroundColor(state) {
        const sem = state.currentSemester;
        if (!sem) return '#f3e9ff';
        const grade = sem.grade;
        const season = sem.season;
        // Âü∫Á°ÄËâ≤Ë∞ÉÔºöÈ´ò‰∏Ä‰∏äÊµÖÁ¥´ÔºåÈ´ò‰∏Ä‰∏ã‰∫ÆÁ¥´ÔºåÈ´ò‰∫å‰∏ä‰∏≠Á¥´ÔºåÈ´ò‰∫å‰∏ãÊ∑±Á¥´ÔºåÈ´ò‰∏â‰∏äÁÅ∞Á¥´ÔºåÈ´ò‰∏â‰∏ãÊöóÁ¥´
        const colors = [
            '#f3e9ff', // È´ò‰∏Ä‰∏ä
            '#e6d9ff', // È´ò‰∏Ä‰∏ã
            '#d9ccff', // È´ò‰∫å‰∏ä
            '#ccbfff', // È´ò‰∫å‰∏ã
            '#bfb2f0', // È´ò‰∏â‰∏ä
            '#b2a5e0'  // È´ò‰∏â‰∏ã
        ];
        let idx = grade * 2 + (season === '‰∏ä' ? 0 : 1);
        idx = Math.min(idx, colors.length-1);
        let base = colors[idx];
        // Âè†Âä†Áä∂ÊÄÅÂéãÊäëÊÑüÔºöÂ¶ÇÊûúÁé©ÂÆ∂Áä∂ÊÄÅÊúâË¥üÈù¢ÔºåÁ®çÂæÆÈôç‰Ωé‰∫ÆÂ∫¶
        if (state.playerStates.some(s => ['burnout','depressed'].includes(s.type))) {
            base = '#c2b0e0';
        }
        return base;
    }
    
    // ---------- ÂÖ®Â±ÄÁä∂ÊÄÅ ----------
    let gameState = {
        semesterId: 'g1s1', classType: 'normal', subject: 'Áâ©ÁêÜ', personality: 'gentle', difficulty: 'normal',
        talents: [], currentSemester: null, week: 0, totalWeeks: 0, stats: { ...BASE_STATS }, log: [],
        gamePhase: 'setup', vacationWeek: 0, vacationType: 'summer', completedSemesters: [], skipWeek: false,
        playerStates: [], achievements: [],
    };
    let currentDetail = { type: null, data: null };
    
    function addLog(msg) { gameState.log.unshift(`Á¨¨${gameState.week}Âë®: ${msg}`); if (gameState.log.length > 12) gameState.log.pop(); }
    function getStateLevel(type) { const s = gameState.playerStates.find(s => s.type === type); return s ? s.level : 0; }
    function addPlayerState(type, level = 1) {
        const ex = gameState.playerStates.find(s => s.type === type);
        ex ? ex.level += level : gameState.playerStates.push({ type, level });
    }
    
    function adjustEventWeight(event) {
        let w = 1;
        const diff = DIFFICULTY[gameState.difficulty];
        if (event.type === 'contest' || event.type === 'club' || event.type === 'sports') w *= diff.posEventMod;
        if (event.options.some(o => o.effects && typeof o.effects === 'object' && (o.effects.rep < 0 || o.effects.cohesion < -3))) w *= diff.negEventMod;
        if (event.type === 'psych' || event.type === 'teacher' || event.type === 'moral' || event.type === 'holiday' || event.type === 'season') {
            w *= 1 + 0.2 * getStateLevel('stressed');
            if (gameState.stats.cohesion < 40) w *= 1.3;
            if (gameState.stats.energy < 30) w *= 1.2;
        }
        return w;
    }
    
    function pickRandomEvent() {
        if (Math.random() < 0.1) {
            const teacher = BASE_EVENTS.filter(e => e.type === 'teacher');
            if (teacher.length) return teacher[Math.floor(Math.random() * teacher.length)];
        }
        const pool = BASE_EVENTS.filter(e => e.type !== 'teacher' && e.type !== 'exam');
        const weights = pool.map(e => adjustEventWeight(e));
        const total = weights.reduce((a,b)=>a+b,0);
        let r = Math.random() * total;
        for (let i=0; i<pool.length; i++) { r -= weights[i]; if (r<=0) return pool[i]; }
        return pool[0];
    }
    
    function checkLowStatEvent() {
        if (gameState.skipWeek) return null;
        for (let ev of LOW_STAT_EVENTS) {
            if (gameState.stats[ev.stat] < ev.threshold) return ev;
        }
        return null;
    }
    
    function weeklyDecay() {
        let mult = 1 - 0.1 * getStateLevel('burnout');
        gameState.stats.avgScore = Math.max(0, gameState.stats.avgScore - 1 * mult);
        gameState.stats.discipline = Math.max(0, gameState.stats.discipline - 1 * mult);
        gameState.stats.hygiene = Math.max(0, gameState.stats.hygiene - 1 * mult);
        gameState.stats.cohesion = Math.max(0, gameState.stats.cohesion - 1 * mult);
        gameState.stats.rep = Math.max(0, gameState.stats.rep - 1 * mult);
        let rec = 15 - 5 * getStateLevel('tired') - 10 * getStateLevel('burnout');
        gameState.stats.energy = Math.min(gameState.stats.maxEnergy, gameState.stats.energy + rec);
        let dep = getStateLevel('depressed');
        if (dep) { gameState.stats.energy -= dep * 5; gameState.stats.cohesion -= dep * 3; }
        if (gameState.talents.includes('t2')) gameState.stats.cohesion = Math.min(100, gameState.stats.cohesion + 2);
    }
    
    function checkAchievements() {
        if (gameState.difficulty !== 'reality') return;
        if (gameState.week === 5 && gameState.stats.discipline > 60 && !gameState.achievements.some(a=>a.name==='Á∫™Âæã‰πãÊòü')) {
            gameState.achievements.push({ name: 'Á∫™Âæã‰πãÊòü', desc: 'ËøûÁª≠5Âë®Á∫™ÂæãËâØÂ•Ω', time: gameState.week });
            alert('ÊàêÂ∞±Ëß£ÈîÅÔºöÁ∫™Âæã‰πãÊòü'); addLog('üéâ ÊàêÂ∞±ÔºöÁ∫™Âæã‰πãÊòü');
        }
        if (gameState.stats.avgScore >= 80 && !gameState.achievements.some(a=>a.name==='Â≠¶Èú∏Áè≠')) {
            gameState.achievements.push({ name: 'Â≠¶Èú∏Áè≠', desc: 'Âπ≥ÂùáÂàÜËææÂà∞80', time: gameState.week });
            alert('ÊàêÂ∞±Ëß£ÈîÅÔºöÂ≠¶Èú∏Áè≠'); addLog('üéâ ÊàêÂ∞±ÔºöÂ≠¶Èú∏Áè≠');
        }
    }
    
    function randomizeTalentsForReality() {
        let shuffled = [...TALENT_LIBRARY].sort(()=>0.5-Math.random());
        let selected = [], total = 0;
        for (let t of shuffled) {
            if (selected.length >= 4) break;
            if (total + t.point <= 2 && total + t.point >= -2) { selected.push(t.id); total += t.point; }
        }
        return selected;
    }
    
    function getLevelText(v, t) {
        if (t === 'energy') { if (v>=80) return 'ÂÖÖÊ≤õ'; if (v>=60) return 'Ê≠£Â∏∏'; if (v>=30) return 'Áñ≤ÊÉ´'; return 'ÈÄèÊîØ'; }
        if (v>=85) return '‰ºòÁßÄ'; if (v>=70) return 'ËâØÂ•Ω'; if (v>=55) return '‰∏≠Á≠â'; if (v>=40) return 'ËæÉÂ∑Æ'; return 'Âç±Èô©';
    }
    
    function render() {
        const container = document.getElementById('gameContainer');
        // Âä®ÊÄÅËÉåÊôØËâ≤
        container.style.backgroundColor = getBackgroundColor(gameState);
        if (gameState.gamePhase === 'setup') { container.innerHTML = renderSetupDifficulty(); attachSetupDifficultyListeners(); }
        else if (gameState.gamePhase === 'setupTalents') { container.innerHTML = renderSetupTalents(); attachSetupTalentsListeners(); }
        else if (gameState.gamePhase === 'playing') { container.innerHTML = renderPlaying(); attachPlayingListeners(); }
        else if (gameState.gamePhase === 'weekend') { container.innerHTML = renderWeekend(); attachWeekendListeners(); }
        else if (gameState.gamePhase === 'vacation') { container.innerHTML = renderVacation(); attachVacationListeners(); }
        else if (gameState.gamePhase === 'ended') { container.innerHTML = renderEnding(); attachEndingListeners(); }
    }
    
    // ---------- ÁïåÈù¢Ê∏≤ÊüìÂáΩÊï∞ ----------
    function renderSetupDifficulty() {
        return `
            <div class="header"><h2>‚öôÔ∏è Á¨¨‰∏ÄÊ≠•ÔºöÂü∫Á°ÄÈÖçÁΩÆ</h2></div>
            <div style="padding:30px">
                <div class="select-row">
                    <select id="semesterSelect">${SEMESTERS.map(s=>`<option value="${s.id}" ${gameState.semesterId===s.id?'selected':''}>${s.label}</option>`).join('')}</select>
                    <select id="classSelect">${Object.entries(CLASS_TYPES).map(([k,v])=>`<option value="${k}" ${gameState.classType===k?'selected':''}>${v.name}</option>`).join('')}</select>
                </div>
                <div class="select-row">
                    <select id="subjectSelect">${CLASS_TYPES[gameState.classType].allowSubjects.map(sub=>`<option value="${sub}" ${gameState.subject===sub?'selected':''}>${sub}</option>`).join('')}</select>
                    <select id="personalitySelect">${Object.entries(PERSONALITY).map(([k,v])=>`<option value="${k}" ${gameState.personality===k?'selected':''}>${v.name}</option>`).join('')}</select>
                </div>
                <div class="select-row">
                    <select id="difficultySelect">${Object.entries(DIFFICULTY).map(([k,v])=>`<option value="${k}" ${gameState.difficulty===k?'selected':''}>${v.name}</option>`).join('')}</select>
                </div>
                <button class="btn" id="nextStepBtn">‰∏ã‰∏ÄÊ≠•ÔºöÂ§©Ëµã</button>
            </div>
        `;
    }
    function attachSetupDifficultyListeners() {
        document.getElementById('semesterSelect')?.addEventListener('change', e => gameState.semesterId = e.target.value);
        document.getElementById('classSelect')?.addEventListener('change', e => { gameState.classType = e.target.value; render(); });
        document.getElementById('subjectSelect')?.addEventListener('change', e => gameState.subject = e.target.value);
        document.getElementById('personalitySelect')?.addEventListener('change', e => gameState.personality = e.target.value);
        document.getElementById('difficultySelect')?.addEventListener('change', e => gameState.difficulty = e.target.value);
        document.getElementById('nextStepBtn')?.addEventListener('click', () => {
            gameState.gamePhase = 'setupTalents';
            gameState.talents = gameState.difficulty === 'reality' ? randomizeTalentsForReality() : [];
            render();
        });
    }
    
    function renderSetupTalents() {
        const isReality = gameState.difficulty === 'reality';
        const pointRequire = DIFFICULTY[gameState.difficulty].pointRequire;
        let talents = sessionStorage.getItem('setupTalents') ? JSON.parse(sessionStorage.getItem('setupTalents')).map(id=>TALENT_LIBRARY.find(t=>t.id===id)) : (()=>{
            let shuffled = [...TALENT_LIBRARY].sort(()=>0.5-Math.random()).slice(0,6);
            sessionStorage.setItem('setupTalents', JSON.stringify(shuffled.map(t=>t.id)));
            return shuffled;
        })();
        const total = gameState.talents.reduce((s,id)=>{let t=TALENT_LIBRARY.find(tt=>tt.id===id); return s+(t?t.point:0);},0);
        return `
            <div class="header"><h2>‚öôÔ∏è Á¨¨‰∫åÊ≠•ÔºöÂ§©ËµãÈÄâÊã©</h2></div>
            <div style="padding:30px">
                <h3 style="color:#2a1b4a">ÂΩìÂâçÈöæÂ∫¶: ${DIFFICULTY[gameState.difficulty].name} (Ë¶ÅÊ±Ç‚â•${pointRequire})</h3>
                <div class="talent-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin:20px 0">
                    ${talents.map(t=>{
                        let sel = gameState.talents.includes(t.id) ? 'selected' : '';
                        return `<div class="talent-card ${sel}" data-talent-id="${t.id}" style="background:rgba(200,170,255,0.5); border-radius:30px; padding:15px; border:2px solid ${sel?'#b38aff':'transparent'}">
                            <div><strong>${t.name}</strong> <span style="color:${t.point<0?'#3a7a3a':'#b34a4a'}">${t.point>0?'+'+t.point:t.point}</span></div>
                            <div style="font-size:0.8rem">${t.desc}</div>
                        </div>`;
                    }).join('')}
                </div>
                <div style="color:#2a1b4a; font-size:1.3rem; margin:20px 0">ÂΩìÂâçÊÄªÂ§©ËµãÁÇπ: ${total} (Ë¶ÅÊ±Ç‚â•${pointRequire})</div>
                <div style="display:flex; gap:15px">
                    <button class="btn secondary" id="backBtn">ËøîÂõû</button>
                    <button class="btn" id="randomizeTalentsBtn" ${isReality?'disabled':''}>Âà∑Êñ∞Â§©Ëµã</button>
                    <button class="btn" id="startGameBtn">ÂºÄÂßãÊ∏∏Êàè</button>
                </div>
            </div>
        `;
    }
    function attachSetupTalentsListeners() {
        const isReality = gameState.difficulty === 'reality';
        if (!isReality) {
            document.querySelectorAll('.talent-card').forEach(c => c.addEventListener('click', ()=>{
                const id = c.dataset.talentId;
                if (gameState.talents.includes(id)) gameState.talents = gameState.talents.filter(t=>t!==id);
                else gameState.talents.push(id);
                render();
            }));
        }
        document.getElementById('backBtn')?.addEventListener('click', ()=>{ gameState.gamePhase='setup'; render(); });
        document.getElementById('randomizeTalentsBtn')?.addEventListener('click', ()=>{ sessionStorage.removeItem('setupTalents'); gameState.talents=[]; render(); });
        document.getElementById('startGameBtn')?.addEventListener('click', ()=>{
            const sem = SEMESTERS.find(s=>s.id===gameState.semesterId);
            gameState.currentSemester = sem;
            gameState.week = 1; gameState.totalWeeks = sem.weeks;
            const ct = CLASS_TYPES[gameState.classType];
            gameState.stats = { ...BASE_STATS, avgScore: BASE_STATS.avgScore+(ct.avgScore||0), discipline: BASE_STATS.discipline+(ct.discipline||0), hygiene: BASE_STATS.hygiene+(ct.hygiene||0), cohesion: BASE_STATS.cohesion+(ct.cohesion||0), rep: BASE_STATS.rep+(ct.rep||0), funds: BASE_STATS.funds, personalFunds: BASE_STATS.personalFunds, energy: BASE_STATS.energy, maxEnergy: BASE_STATS.maxEnergy };
            if (gameState.talents.includes('t12')) { gameState.stats.maxEnergy -= 10; gameState.stats.energy = Math.min(gameState.stats.energy, gameState.stats.maxEnergy); }
            gameState.log = ['Ê∏∏ÊàèÂºÄÂßãÔºÅ']; gameState.gamePhase = 'playing';
            sessionStorage.removeItem('setupTalents'); render();
        });
    }
    
    function renderPlaying() {
        const sem = gameState.currentSemester;
        const stats = gameState.stats;
        let event;
        if (!gameState.skipWeek) {
            const low = checkLowStatEvent();
            if (low) { event = low; if (low.id==='low1') gameState.skipWeek=true; }
            else if (gameState.week >= gameState.totalWeeks) event = EXAM_EVENTS[Math.floor(Math.random()*EXAM_EVENTS.length)];
            else event = pickRandomEvent();
        } else { event = LOW_STAT_EVENTS.find(e=>e.id==='low1'); gameState.skipWeek=false; }
        gameState.currentEvent = event;
    
        const optionsHtml = event.options.map((opt,i)=>`<button class="option-btn" data-opt-index="${i}" ${opt.personality && opt.personality!==gameState.personality?'disabled':''}>${opt.text}</button>`).join('');
    
        const stateTags = gameState.playerStates.map(s=>`<span class="status-item" data-state="${s.type}">${PLAYER_STATE_EFFECTS[s.type].name}${s.level>1?' x'+s.level:''}</span>`).join('');
        const achievementTags = gameState.achievements.map(a=>`<span class="achievement-tag" data-achievement="${a.name}">${a.name}</span>`).join('');
        const talentTags = gameState.talents.map(id=>{let t=TALENT_LIBRARY.find(tt=>tt.id===id); return t?`<span class="talent-tag" data-talent="${t.id}">${t.name}</span>`:''}).join('');
    
        let detailHtml = '<div class="detail-title">ÁÇπÂáªÊ†áÁ≠æÊü•ÁúãËØ¶ÊÉÖ</div><div class="detail-content">‚Äî</div>';
        if (currentDetail.type==='state') { let s=PLAYER_STATE_EFFECTS[currentDetail.data]; detailHtml=`<div class="detail-title">Áä∂ÊÄÅÔºö${s.name}</div><div class="detail-content">${s.desc}</div>`; }
        else if (currentDetail.type==='achievement') { let a=gameState.achievements.find(a=>a.name===currentDetail.data); if(a) detailHtml=`<div class="detail-title">ÊàêÂ∞±Ôºö${a.name}</div><div class="detail-content">${a.desc} (Á¨¨${a.time}Âë®)</div>`; }
        else if (currentDetail.type==='talent') { let t=TALENT_LIBRARY.find(tt=>tt.id===currentDetail.data); if(t) detailHtml=`<div class="detail-title">Â§©ËµãÔºö${t.name}</div><div class="detail-content">${t.desc}</div>`; }
    
        return `
            <div class="header">
                <h2>${gameState.subject} ¬∑ ${sem.label} 16Áè≠</h2>
                <span class="badge">Á¨¨ ${gameState.week}/${gameState.totalWeeks} Âë®</span>
            </div>
            <div class="main-row">
                <div class="left-col">
                    <div class="stats-panel">
                        <div class="stat-item"><span class="stat-label">Âπ≥ÂùáÂàÜ</span><span class="stat-value">${getLevelText(stats.avgScore)}</span></div>
                        <div class="stat-item"><span class="stat-label">Á∫™Âæã</span><span class="stat-value">${getLevelText(stats.discipline)}</span></div>
                        <div class="stat-item"><span class="stat-label">Âç´Áîü</span><span class="stat-value">${getLevelText(stats.hygiene)}</span></div>
                        <div class="stat-item"><span class="stat-label">ÂáùËÅöÂäõ</span><span class="stat-value">${getLevelText(stats.cohesion)}</span></div>
                        <div class="stat-item"><span class="stat-label">Â£∞Êúõ</span><span class="stat-value">${getLevelText(stats.rep)}</span></div>
                        <div class="stat-item"><span class="stat-label">Á≤æÂäõ</span><span class="stat-value ${stats.energy<0?'warning':''}">${getLevelText(stats.energy,'energy')}</span></div>
                        <div class="stat-item"><span class="stat-label">Áè≠Ë¥π</span><span class="stat-value">${stats.funds}</span></div>
                        <div class="stat-item"><span class="stat-label">‰∏™‰∫∫</span><span class="stat-value">${stats.personalFunds}</span></div>
                    </div>
                    <div class="status-bar">${stateTags || '<span>Êó†Áä∂ÊÄÅ</span>'}</div>
                    <div class="log-area">${gameState.log.map(l=>`<div class="log-entry">${l}</div>`).join('')}</div>
                </div>
                <div class="right-col">
                    <div class="event-area">
                        <div class="event-title">${event.title}</div>
                        <div class="event-desc">${event.desc}</div>
                        <div class="option-buttons" id="eventOptions">${optionsHtml}</div>
                    </div>
                    <div class="talent-view"><h4>‚ú®Â§©Ëµã</h4>${talentTags||'Êó†'}</div>
                    <div class="talent-view"><h4>üèÜÊàêÂ∞±</h4>${achievementTags||'Êó†'}</div>
                    <div class="detail-panel">${detailHtml}</div>
                </div>
            </div>
            <div class="control-bar"><button class="btn secondary" id="newGameBtn">ËÄÅÂ≠ê‰∏çÂπ≤‰∫Ü</button></div>
        `;
    }
    
    function attachPlayingListeners() {
        document.querySelectorAll('#eventOptions .option-btn').forEach(btn=>btn.addEventListener('click',e=>{
            let idx = e.target.dataset.optIndex;
            let opt = gameState.currentEvent.options[idx];
            let eff = Array.isArray(opt.effects) ? opt.effects[Math.floor(Math.random()*opt.effects.length)] : opt.effects;
            for (let [k,v] of Object.entries(eff)) {
                if (k==='energy') gameState.stats.energy += v;
                else if (k==='funds') gameState.stats.funds += v;
                else if (k==='personalFunds') gameState.stats.personalFunds += v;
                else if (k in gameState.stats) gameState.stats[k] = Math.min(100, Math.max(-100, gameState.stats[k] + v));
            }
            addLog(`ÈÄâÊã©‰∫Ü„Äå${opt.text}„Äç`);
            if (opt.teacherStateEffect) addPlayerState(opt.teacherStateEffect, 1);
            if (gameState.week >= gameState.totalWeeks) finishSemester();
            else gameState.gamePhase = 'weekend';
            render();
        }));
        document.querySelectorAll('.status-item[data-state]').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'state',data:el.dataset.state}; render(); }));
        document.querySelectorAll('.achievement-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'achievement',data:el.dataset.achievement}; render(); }));
        document.querySelectorAll('.talent-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'talent',data:el.dataset.talent}; render(); }));
        document.getElementById('newGameBtn')?.addEventListener('click',()=>{ if(confirm('ÈáçÊñ∞ÂºÄÂßãÔºü')) resetGame(); });
    }
    
    function finishSemester() {
        gameState.completedSemesters.push(gameState.currentSemester.id);
        gameState.vacationType = gameState.currentSemester.season === '‰∏ä' ? 'winter' : 'summer';
        gameState.vacationWeek = 1;
        addLog('Â≠¶ÊúüÁªìÊùüÔºåËøõÂÖ•ÂÅáÊúü');
        gameState.gamePhase = 'vacation';
        gameState.stats.energy = Math.min(gameState.stats.maxEnergy, gameState.stats.energy + 10);
        checkAchievements();
    }
    
    function renderWeekend() {
        const stats = gameState.stats;
        const activities = WEEKEND_ACTIVITIES.map((act, idx) => {
            let eff = act.effects;
            let energyChange = Array.isArray(eff) ? eff[0].energy : (eff.energy || 0);
            return `<button class="option-btn" data-act-index="${idx}">${act.name} (Á≤æÂäõ ${energyChange<0?energyChange:'+'+energyChange})</button>`;
        }).join('');
        const stateTags = gameState.playerStates.map(s=>`<span class="status-item" data-state="${s.type}">${PLAYER_STATE_EFFECTS[s.type].name}${s.level>1?' x'+s.level:''}</span>`).join('');
        const achievementTags = gameState.achievements.map(a=>`<span class="achievement-tag" data-achievement="${a.name}">${a.name}</span>`).join('');
        const talentTags = gameState.talents.map(id=>{let t=TALENT_LIBRARY.find(tt=>tt.id===id); return t?`<span class="talent-tag" data-talent="${t.id}">${t.name}</span>`:''}).join('');
        let detailHtml = '<div class="detail-title">ÁÇπÂáªÊ†áÁ≠æÊü•ÁúãËØ¶ÊÉÖ</div><div class="detail-content">‚Äî</div>';
        if (currentDetail.type==='state') { let s=PLAYER_STATE_EFFECTS[currentDetail.data]; detailHtml=`<div class="detail-title">Áä∂ÊÄÅÔºö${s.name}</div><div class="detail-content">${s.desc}</div>`; }
        else if (currentDetail.type==='achievement') { let a=gameState.achievements.find(a=>a.name===currentDetail.data); if(a) detailHtml=`<div class="detail-title">ÊàêÂ∞±Ôºö${a.name}</div><div class="detail-content">${a.desc} (Á¨¨${a.time}Âë®)</div>`; }
        else if (currentDetail.type==='talent') { let t=TALENT_LIBRARY.find(tt=>tt.id===currentDetail.data); if(t) detailHtml=`<div class="detail-title">Â§©ËµãÔºö${t.name}</div><div class="detail-content">${t.desc}</div>`; }
        return `
            <div class="header">
                <h2>Âë®Êú´ ¬∑ Á¨¨${gameState.week}Âë®</h2>
                <span class="badge">Á≤æÂäõ ${getLevelText(stats.energy,'energy')}</span>
            </div>
            <div class="main-row">
                <div class="left-col">
                    <div class="stats-panel" style="grid-template-columns:repeat(4,1fr)">
                        <div class="stat-item"><span class="stat-label">Âπ≥ÂùáÂàÜ</span><span>${getLevelText(stats.avgScore)}</span></div>
                        <div class="stat-item"><span class="stat-label">ÂáùËÅöÂäõ</span><span>${getLevelText(stats.cohesion)}</span></div>
                        <div class="stat-item"><span class="stat-label">Â£∞Êúõ</span><span>${getLevelText(stats.rep)}</span></div>
                        <div class="stat-item"><span class="stat-label">Áè≠Ë¥π/‰∏™‰∫∫</span><span>${stats.funds}/${stats.personalFunds}</span></div>
                    </div>
                    <div class="status-bar">${stateTags || '<span>Êó†Áä∂ÊÄÅ</span>'}</div>
                    <div class="log-area">${gameState.log.map(l=>`<div class="log-entry">${l}</div>`).join('')}</div>
                </div>
                <div class="right-col">
                    <div class="event-area">
                        <div class="event-title">Âë®Êú´ÂÅö‰ªÄ‰πàÔºü</div>
                        <div class="event-desc">‰Ω†ÂèØ‰ª•Âà©Áî®Âë®Êú´Â§ÑÁêÜÁè≠Á∫ß‰∫ãÂä°ÔºåÊàñËÄÖ‰ºëÊÅØÊÅ¢Â§çÁ≤æÂäõ„ÄÇ</div>
                        <div class="option-buttons" id="weekendOptions">${activities}</div>
                    </div>
                    <div class="talent-view"><h4>‚ú®Â§©Ëµã</h4>${talentTags||'Êó†'}</div>
                    <div class="talent-view"><h4>üèÜÊàêÂ∞±</h4>${achievementTags||'Êó†'}</div>
                    <div class="detail-panel">${detailHtml}</div>
                </div>
            </div>
            <div class="control-bar"><button class="btn secondary" id="newGameBtn">ËÄÅÂ≠ê‰∏çÂπ≤‰∫Ü</button></div>
        `;
    }
    
    function attachWeekendListeners() {
        document.querySelectorAll('#weekendOptions .option-btn').forEach(btn=>btn.addEventListener('click',e=>{
            let idx = e.target.dataset.actIndex;
            let act = WEEKEND_ACTIVITIES[idx];
            let eff = Array.isArray(act.effects) ? act.effects[Math.floor(Math.random()*act.effects.length)] : act.effects;
            for (let [k,v] of Object.entries(eff)) {
                if (k==='energy') gameState.stats.energy += v;
                else if (k==='funds') gameState.stats.funds += v;
                else if (k==='personalFunds') gameState.stats.personalFunds += v;
                else if (k in gameState.stats) gameState.stats[k] = Math.min(100, Math.max(-100, gameState.stats[k] + v));
            }
            addLog(`Âë®Êú´Ôºö${act.name}`);
            weeklyDecay();
            gameState.week++;
            if (gameState.week > gameState.totalWeeks) finishSemester();
            else gameState.gamePhase = 'playing';
            checkAchievements();
            render();
        }));
        document.querySelectorAll('.status-item[data-state]').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'state',data:el.dataset.state}; render(); }));
        document.querySelectorAll('.achievement-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'achievement',data:el.dataset.achievement}; render(); }));
        document.querySelectorAll('.talent-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'talent',data:el.dataset.talent}; render(); }));
        document.getElementById('newGameBtn')?.addEventListener('click',()=>{ if(confirm('ÈáçÊñ∞ÂºÄÂßãÔºü')) resetGame(); });
    }
    
    function renderVacation() {
        const vacEvents = VACATION_EVENTS[gameState.vacationType];
        const eventIdx = (gameState.vacationWeek - 1) % vacEvents.length;
        const event = vacEvents[eventIdx];
        const optionsHtml = event.options.map((opt,i)=>`<button class="option-btn" data-opt-index="${i}">${opt.text}</button>`).join('');
        const stateTags = gameState.playerStates.map(s=>`<span class="status-item" data-state="${s.type}">${PLAYER_STATE_EFFECTS[s.type].name}${s.level>1?' x'+s.level:''}</span>`).join('');
        const achievementTags = gameState.achievements.map(a=>`<span class="achievement-tag" data-achievement="${a.name}">${a.name}</span>`).join('');
        const talentTags = gameState.talents.map(id=>{let t=TALENT_LIBRARY.find(tt=>tt.id===id); return t?`<span class="talent-tag" data-talent="${t.id}">${t.name}</span>`:''}).join('');
        let detailHtml = '<div class="detail-title">ÁÇπÂáªÊ†áÁ≠æÊü•ÁúãËØ¶ÊÉÖ</div><div class="detail-content">‚Äî</div>';
        if (currentDetail.type==='state') { let s=PLAYER_STATE_EFFECTS[currentDetail.data]; detailHtml=`<div class="detail-title">Áä∂ÊÄÅÔºö${s.name}</div><div class="detail-content">${s.desc}</div>`; }
        else if (currentDetail.type==='achievement') { let a=gameState.achievements.find(a=>a.name===currentDetail.data); if(a) detailHtml=`<div class="detail-title">ÊàêÂ∞±Ôºö${a.name}</div><div class="detail-content">${a.desc} (Á¨¨${a.time}Âë®)</div>`; }
        else if (currentDetail.type==='talent') { let t=TALENT_LIBRARY.find(tt=>tt.id===currentDetail.data); if(t) detailHtml=`<div class="detail-title">Â§©ËµãÔºö${t.name}</div><div class="detail-content">${t.desc}</div>`; }
        return `
            <div class="header">
                <h2>${gameState.vacationType==='winter'?'‚ùÑÔ∏è ÂØíÂÅá':'‚òÄÔ∏è ÊöëÂÅá'} Á¨¨${gameState.vacationWeek}/3Âë®</h2>
            </div>
            <div class="main-row">
                <div class="left-col">
                    <div class="stats-panel" style="grid-template-columns:repeat(4,1fr)">
                        <div class="stat-item"><span class="stat-label">Âπ≥ÂùáÂàÜ</span><span>${getLevelText(gameState.stats.avgScore)}</span></div>
                        <div class="stat-item"><span class="stat-label">ÂáùËÅöÂäõ</span><span>${getLevelText(gameState.stats.cohesion)}</span></div>
                        <div class="stat-item"><span class="stat-label">Â£∞Êúõ</span><span>${getLevelText(gameState.stats.rep)}</span></div>
                        <div class="stat-item"><span class="stat-label">Áè≠Ë¥π/‰∏™‰∫∫</span><span>${gameState.stats.funds}/${gameState.stats.personalFunds}</span></div>
                    </div>
                    <div class="status-bar">${stateTags || '<span>Êó†Áä∂ÊÄÅ</span>'}</div>
                    <div class="log-area">${gameState.log.map(l=>`<div class="log-entry">${l}</div>`).join('')}</div>
                </div>
                <div class="right-col">
                    <div class="event-area">
                        <div class="event-title">${event.title}</div>
                        <div class="event-desc">${event.desc}</div>
                        <div class="option-buttons" id="vacationOptions">${optionsHtml}</div>
                    </div>
                    <div class="talent-view"><h4>‚ú®Â§©Ëµã</h4>${talentTags||'Êó†'}</div>
                    <div class="talent-view"><h4>üèÜÊàêÂ∞±</h4>${achievementTags||'Êó†'}</div>
                    <div class="detail-panel">${detailHtml}</div>
                </div>
            </div>
            <div class="control-bar"><button class="btn secondary" id="newGameBtn">ËÄÅÂ≠ê‰∏çÂπ≤‰∫Ü</button></div>
        `;
    }
    
    function attachVacationListeners() {
        document.querySelectorAll('#vacationOptions .option-btn').forEach(btn=>btn.addEventListener('click',e=>{
            let idx = e.target.dataset.optIndex;
            let vacEvents = VACATION_EVENTS[gameState.vacationType];
            let eventIdx = (gameState.vacationWeek-1) % vacEvents.length;
            let opt = vacEvents[eventIdx].options[idx];
            let eff = Array.isArray(opt.effects) ? opt.effects[Math.floor(Math.random()*opt.effects.length)] : opt.effects;
            for (let [k,v] of Object.entries(eff)) {
                if (k==='energy') gameState.stats.energy += v;
                else if (k==='funds') gameState.stats.funds += v;
                else if (k==='personalFunds') gameState.stats.personalFunds += v;
                else if (k in gameState.stats) gameState.stats[k] = Math.min(100, Math.max(-100, gameState.stats[k] + v));
            }
            addLog(`ÂÅáÊúüÔºö${opt.text}`);
            if (gameState.vacationWeek >= 3) {
                if (confirm('ÂÅáÊúüÁªìÊùü„ÄÇÊòØÂê¶ÁªßÁª≠Â∏¶Ëøô‰∏™Áè≠ËøõÂÖ•‰∏ã‰∏ÄÂ≠¶ÊúüÔºü')) {
                    let nextId = gameState.currentSemester.next;
                    if (nextId) {
                        let nextSem = SEMESTERS.find(s=>s.id===nextId);
                        gameState.currentSemester = nextSem;
                        gameState.week = 1; gameState.totalWeeks = nextSem.weeks;
                        gameState.gamePhase = 'playing';
                        gameState.stats.energy = gameState.stats.maxEnergy;
                        addLog(`ËøõÂÖ•${nextSem.label}`);
                    } else { gameState.gamePhase = 'ended'; }
                } else { gameState.gamePhase = 'ended'; }
            } else { gameState.vacationWeek++; }
            checkAchievements(); render();
        }));
        document.querySelectorAll('.status-item[data-state]').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'state',data:el.dataset.state}; render(); }));
        document.querySelectorAll('.achievement-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'achievement',data:el.dataset.achievement}; render(); }));
        document.querySelectorAll('.talent-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'talent',data:el.dataset.talent}; render(); }));
        document.getElementById('newGameBtn')?.addEventListener('click',()=>{ if(confirm('ÈáçÊñ∞ÂºÄÂßãÔºü')) resetGame(); });
    }
    
    function renderEnding() {
        const s = gameState.stats;
        const score = Math.round(s.avgScore*0.3 + s.discipline*0.2 + s.hygiene*0.1 + s.cohesion*0.2 + s.rep*0.2);
        let grade = 'D';
        if (score >= 90) grade = 'S';
        else if (score >= 75) grade = 'A';
        else if (score >= 60) grade = 'B';
        else if (score >= 40) grade = 'C';
        return `
            <div class="header"><h2>üèÅ Áè≠‰∏ª‰ªªÁîüÊ∂Ø ¬∑ ÁªìÂ±Ä</h2></div>
            <div style="padding:30px; text-align:center">
                <div style="font-size:3rem; margin:20px 0; color:#2a1b4a">${grade}Á∫ß</div>
                <div style="font-size:1.2rem; color:#3a2b5a">ÁªºÂêàËØÑÂàÜ: ${score}</div>
                <div style="margin:30px 0; color:#3a2b5a">Â∏¶ÂÆåÂ≠¶Êúü: ${gameState.completedSemesters.length}</div>
                <div style="color:#3a2b5a">ÊàêÂ∞±: ${gameState.achievements.map(a=>a.name).join(', ') || 'Êó†'}</div>
                <button class="btn" id="newGameBtn" style="margin-top:30px">ËÄÅÂ≠ê‰∏çÂπ≤‰∫Ü</button>
            </div>
        `;
    }
    
    function attachEndingListeners() {
        document.getElementById('newGameBtn')?.addEventListener('click', resetGame);
    }
    
    function resetGame() {
        gameState = {
            semesterId: 'g1s1', classType: 'normal', subject: 'Áâ©ÁêÜ', personality: 'gentle', difficulty: 'normal',
            talents: [], currentSemester: null, week: 0, totalWeeks: 0, stats: { ...BASE_STATS }, log: [],
            gamePhase: 'setup', vacationWeek: 0, vacationType: 'summer', completedSemesters: [], skipWeek: false,
            playerStates: [], achievements: [],
        };
        currentDetail = { type: null, data: null };
        sessionStorage.removeItem('setupTalents');
        render();
    }
    
    render();
})();
</script>
</body>
</html>
