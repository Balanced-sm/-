<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ä¸»ä»»æ¨¡æ‹Ÿå™¨ Â· åå…­ç­çš„æ—¥å¸¸ Â· æœ€ç»ˆç« </title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: #f0e6ff; /* æµ…ç´«èƒŒæ™¯ */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .game-container {
            max-width: 1300px;
            width: 100%;
            background: #f3e9ff; /* æ›´æµ…çš„é»˜è®¤ç´«è‰²ï¼Œä¼šè¢«jsåŠ¨æ€è¦†ç›–ä½†ä¿æŒæ˜äº®åŸºè°ƒ */
            border-radius: 40px;
            box-shadow: 0 20px 40px rgba(120, 80, 200, 0.2);
            overflow: hidden;
            border: 2px solid rgba(200, 180, 255, 0.6);
            transition: background-color 0.5s ease;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: rgba(200, 180, 255, 0.7);
            backdrop-filter: blur(8px);
            color: #2a1b4a;
            padding: 20px 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid rgba(180, 140, 255, 0.5);
        }
        .header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            text-shadow: 0 0 8px #ffffff;
            letter-spacing: 1px;
        }
        .badge {
            background: #d9b3ff;
            color: #2a1b4a;
            padding: 8px 20px;
            border-radius: 60px;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 0 10px #c299ff;
        }
        .main-row {
            display: flex;
            flex-wrap: wrap;
        }
        .left-col {
            flex: 2;
            min-width: 350px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(4px);
            border-right: 1px solid rgba(200, 160, 255, 0.5);
        }
        .right-col {
            flex: 3;
            min-width: 500px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4,1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: rgba(255, 240, 255, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 24px;
            padding: 12px 10px;
            border: 1px solid rgba(180, 130, 255, 0.5);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #4a2b7a;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2a1b4a;
            text-shadow: 0 0 4px #ffffff;
        }
        .stat-value.warning {
            color: #b34a4a;
        }
        .status-bar {
            background: rgba(220, 200, 255, 0.7);
            backdrop-filter: blur(8px);
            padding: 15px 20px;
            border-radius: 60px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid #b38aff;
        }
        .status-item {
            background: rgba(200, 170, 255, 0.5);
            border-radius: 40px;
            padding: 8px 18px;
            font-size: 0.95rem;
            color: #2a1b4a;
            cursor: pointer;
            border: 1px solid #b38aff;
            transition: 0.2s;
            backdrop-filter: blur(4px);
        }
        .status-item:hover {
            background: #c299ff;
            border-color: white;
        }
        .event-area {
            background: rgba(255, 245, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #d9b3ff;
        }
        .event-title {
            font-size: 1.6rem;
            font-weight: 600;
            color: #2a1b4a;
            text-shadow: 0 0 5px #ffffff;
            margin-bottom: 10px;
        }
        .event-desc {
            color: #3a2b5a;
            line-height: 1.5;
            margin-bottom: 25px;
            font-size: 1rem;
        }
        .option-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .option-btn {
            background: rgba(200, 180, 255, 0.5);
            backdrop-filter: blur(8px);
            border: 1px solid #b38aff;
            border-radius: 60px;
            padding: 14px 20px;
            font-size: 1.1rem;
            text-align: left;
            color: #2a1b4a;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .option-btn:hover {
            background: #d9b3ff;
            border-color: white;
            transform: scale(1.02);
        }
        .option-btn:disabled {
            opacity: 0.3;
            pointer-events: none;
        }
        .log-area {
            background: rgba(255, 240, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 30px;
            padding: 15px 20px;
            color: #2a1b4a;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #b38aff;
            margin-bottom: 20px;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px dashed #a56eff;
        }
        .talent-view {
            background: rgba(255, 240, 255, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 30px;
            padding: 15px 20px;
            margin-bottom: 15px;
            border: 1px solid #d9b3ff;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .talent-view h4 {
            width: 100%;
            color: #2a1b4a;
            margin-bottom: 5px;
            font-size: 1.2rem;
        }
        .talent-tag, .achievement-tag {
            background: #c299ff;
            border-radius: 40px;
            padding: 6px 16px;
            color: #2a1b4a;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid #a56eff;
        }
        .talent-tag:hover, .achievement-tag:hover {
            background: #d9b3ff;
        }
        .detail-panel {
            background: rgba(255, 245, 255, 0.8);
            backdrop-filter: blur(12px);
            border-radius: 30px;
            padding: 15px 25px;
            border: 1px solid #d9b3ff;
            min-height: 100px;
        }
        .detail-title {
            font-weight: 600;
            color: #2a1b4a;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        .detail-content {
            color: #3a2b5a;
            font-size: 1rem;
            white-space: pre-wrap;
        }
        .control-bar {
            display: flex;
            gap: 15px;
            padding: 10px 20px 20px;
        }
        .btn {
            background: #b38aff;
            border: none;
            color: #2a1b4a;
            padding: 14px 30px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.2rem;
            flex: 1;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 0 15px #c299ff;
            border: 1px solid #d9b3ff;
        }
        .btn.secondary {
            background: #d9b3ff;
        }
        .btn:hover {
            background: #c299ff;
        }
        .select-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .select-row select, .select-row button {
            flex: 1 1 150px;
            padding: 12px;
            border-radius: 60px;
            border: 1px solid #b38aff;
            background: rgba(220, 200, 255, 0.7);
            color: #2a1b4a;
            font-size: 1rem;
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body>
<div class="game-container" id="gameContainer"></div>

<script>
(function() {
    // ---------- å¤©èµ‹åº“ ----------
    const TALENT_LIBRARY = [
        { id: 't1', name: 'ç«çœ¼é‡‘ç›', desc: 'çªå‘æ¶æ€§äº‹ä»¶æ¦‚ç‡é™ä½20%', point: -2, type: 'pos' },
        { id: 't2', name: 'é¸¡æ±¤å¤§å¸ˆ', desc: 'æ¯å‘¨è‡ªåŠ¨æ¢å¤2ç‚¹å‡èšåŠ›', point: -1, type: 'pos' },
        { id: 't3', name: 'äººè„‰ç‹', desc: 'å£°æœ›è¡°å‡å‡åŠï¼Œ10%æ¦‚ç‡+5å£°æœ›', point: -3, type: 'pos' },
        { id: 't4', name: 'é‡‘ç‰Œè°ƒè§£', desc: 'å‡èšåŠ›äº‹ä»¶æ•ˆæœ+15%', point: -2, type: 'pos' },
        { id: 't5', name: 'å¥åº·å«å£«', desc: 'å«ç”Ÿè¡°å‡é™ä½30%', point: -1, type: 'pos' },
        { id: 't6', name: 'æ—¶é—´ç®¡ç†', desc: 'æ‰€æœ‰äº‹ä»¶ç²¾åŠ›æ¶ˆè€—-2', point: -2, type: 'pos' },
        { id: 't13', name: 'ç«èµ›æ•™ç»ƒ', desc: 'ç«èµ›ç”ŸåŸ¹å…»æ•ˆç‡+20%', point: -2, type: 'pos' },
        { id: 't14', name: 'ç¤¾å›¢ä¹‹å‹', desc: 'ç¤¾å›¢æ´»åŠ¨æ•ˆæœ+30%', point: -1, type: 'pos' },
        { id: 't16', name: 'å¿ƒç†ç–å¯¼å¸ˆ', desc: 'å¿ƒç†é—®é¢˜äº‹ä»¶æˆåŠŸç‡+20%', point: -2, type: 'pos' },
        { id: 't17', name: 'è‡ªæˆ‘å…³æ€€', desc: 'ç­ä¸»ä»»å¿ƒç†çŠ¶æ€æ¶åŒ–é€Ÿåº¦å‡åŠ', point: -2, type: 'pos' },
        { id: 't7', name: 'è„¸ç›²', desc: 'å‡èšåŠ›è¡°å‡+20%ï¼Œä¸ªä½“äº‹ä»¶æˆåŠŸç‡-10%', point: 3, type: 'neg' },
        { id: 't8', name: 'æ‹–å»¶ç—‡', desc: 'ç²¾åŠ›æ¢å¤-10%ï¼Œçªå‘äº‹ä»¶å¤±è´¥+15%', point: 2, type: 'neg' },
        { id: 't9', name: 'å¿ƒç›´å£å¿«', desc: 'å®¶é•¿äº‹ä»¶å£°æœ›ä¸‹é™æ¦‚ç‡+20%', point: 2, type: 'neg' },
        { id: 't10', name: 'å®Œç¾ä¸»ä¹‰', desc: 'ç²¾åŠ›æ¶ˆè€—+3ï¼Œçºªå¾‹æ•ˆæœ+10%', point: 1, type: 'neg' },
        { id: 't11', name: 'æ‰‹æœºä¾èµ–', desc: '10%æ¦‚ç‡è·³è¿‡äº‹ä»¶', point: 1, type: 'neg' },
        { id: 't12', name: 'è€å¥½äºº', desc: '30%é¢å¤–äº‹ä»¶ï¼Œç²¾åŠ›ä¸Šé™-10', point: 3, type: 'neg' },
        { id: 't15', name: 'ç«èµ›ç„¦è™‘', desc: 'ç«èµ›ç”Ÿå‹åŠ›å¤§ï¼Œå‡èšåŠ›ä¸‹é™+10%', point: 2, type: 'neg' },
    ];

    const SEMESTERS = [
        { id: 'g1s1', label: 'é«˜ä¸€ä¸Šå­¦æœŸ', grade: 0, season: 'ä¸Š', weeks: 18, next: 'g1s2' },
        { id: 'g1s2', label: 'é«˜ä¸€ä¸‹å­¦æœŸ', grade: 0, season: 'ä¸‹', weeks: 16, next: 'g2s1' },
        { id: 'g2s1', label: 'é«˜äºŒä¸Šå­¦æœŸ', grade: 1, season: 'ä¸Š', weeks: 18, next: 'g2s2' },
        { id: 'g2s2', label: 'é«˜äºŒä¸‹å­¦æœŸ', grade: 1, season: 'ä¸‹', weeks: 16, next: 'g3s1' },
        { id: 'g3s1', label: 'é«˜ä¸‰ä¸Šå­¦æœŸ', grade: 2, season: 'ä¸Š', weeks: 18, next: 'g3s2' },
        { id: 'g3s2', label: 'é«˜ä¸‰ä¸‹å­¦æœŸ', grade: 2, season: 'ä¸‹', weeks: 14, next: null }
    ];
    
    const CLASS_TYPES = {
        rocket: { name: 'ç«ç®­ç­', avgScore: 20, discipline: 10, cohesion: -5, rep: 0, hygiene: 0, allowSubjects: ['è¯­æ–‡','æ•°å­¦','è‹±è¯­','ç‰©ç†','åŒ–å­¦','ç”Ÿç‰©'] },
        normal: { name: 'å¹³è¡Œç­', avgScore: 0, discipline: 0, cohesion: 0, rep: 0, hygiene: 0, allowSubjects: ['è¯­æ–‡','æ•°å­¦','è‹±è¯­','ç‰©ç†','åŒ–å­¦','ç”Ÿç‰©','å†å²','æ”¿æ²»','åœ°ç†'] },
        art: { name: 'è‰ºæœ¯ç­', avgScore: -15, cohesion: 15, hygiene: 5, discipline: 0, rep: 0, allowSubjects: ['è¯­æ–‡','æ•°å­¦','è‹±è¯­'] },
        contest: { name: 'ç«èµ›ç­', avgScore: 30, discipline: -5, cohesion: -10, rep: 10, hygiene: -5, allowSubjects: ['æ•°å­¦','ç‰©ç†'] }
    };
    
    const PERSONALITY = {
        strict: { name: 'ä¸¥å‰å‹' }, gentle: { name: 'æ¸©å’Œå‹' }, laidback: { name: 'æ”¾å…»å‹' }
    };
    
    const DIFFICULTY = {
        easy: { name: 'ç®€å•', pointRequire: -2, posEventMod: 1.1, negEventMod: 0.9 },
        normal: { name: 'æ™®é€š', pointRequire: 0, posEventMod: 1.0, negEventMod: 1.0 },
        hard: { name: 'å›°éš¾', pointRequire: 2, posEventMod: 0.9, negEventMod: 1.1 },
        reality: { name: 'ç°å®æ¨¡å¼', pointRequire: 0, posEventMod: 1.0, negEventMod: 1.0, reality: true }
    };
    
    // ---------- äº‹ä»¶åº“ ----------
    const BASE_EVENTS = [
        { id: 'e1', title: 'æ™šè‡ªä¹ ç©æ‰‹æœº', desc: 'ä½ å·¡ç­æ—¶å‘ç°åæ’çš„å°ç‹æ­£åœ¨æ‰“æ¸¸æˆã€‚', type: 'common',
          options: [
              { text: 'é“è…•æ²¡æ”¶', effects: { discipline: 8, rep: 5, cohesion: -5, energy: -8 } },
              { text: 'ç§ä¸‹è°ˆè¯', effects: { discipline: 2, cohesion: 5, rep: 1, energy: -5 } },
              { text: 'å¹½é»˜åŒ–è§£', personality: 'gentle', effects: { cohesion: 10, energy: -3, rep: -2 } }
          ]},
        { id: 'e2', title: 'æµæ„Ÿçˆ†å‘', desc: 'ç­é‡Œåå¤šä¸ªå­¦ç”Ÿæ„Ÿå†’è¯·å‡ã€‚', type: 'common',
          options: [
              { text: 'å…¨é¢æ¶ˆæ¯’', effects: { hygiene: 10, cohesion: 5, energy: -10, funds: -50 } }, // ç­è´¹
              { text: 'ç…§å¸¸ä¸Šè¯¾', effects: { avgScore: -3, hygiene: -5 } },
              { text: 'ç”³è¯·ç½‘è¯¾', effects: { energy: -2, avgScore: -1, rep: 3 } }
          ]},
        { id: 'c1', title: 'ç«èµ›æŠ¥å', desc: 'æ•°å­¦è”èµ›å¼€å§‹æŠ¥åã€‚', type: 'contest',
          options: [
              { text: 'é¼“åŠ±å…¨å‘˜', effects: { avgScore: 2, cohesion: 5, energy: -6, funds: -30 } }, // ç­è´¹
              { text: 'å°–å­é›†è®­', effects: { avgScore: 5, cohesion: -2, energy: -10, funds: -60, rep: 8 } }, // ç­è´¹
              { text: 'ä¸ç»„ç»‡', effects: { cohesion: -3, rep: -2 } }
          ]},
        { id: 'c4', title: 'ç«èµ›ç”Ÿé€€å½¹', desc: 'æœ‰ç«èµ›ç”Ÿå› å‹åŠ›è¿‡å¤§å†³å®šé€€å‡ºã€‚', type: 'contest',
          options: [
              { text: 'å¿ƒç†ç–å¯¼', effects: { cohesion: 5, avgScore: -1, energy: -8 } },
              { text: 'é¼“åŠ±åšæŒ', effects: { avgScore: 2, cohesion: -5, rep: 2 } },
              { text: 'å°Šé‡å†³å®š', effects: { cohesion: 3, rep: 1, energy: -2 } }
          ]},
        // èŠ‚æ—¥ä¸å­£èŠ‚
        { id: 'hol1', title: 'ä¸­ç§‹ä½³èŠ‚', desc: 'å­¦æ ¡å‘äº†ä¸€ç¬”æœˆé¥¼ç»è´¹ï¼Œä½†ä¸å¤Ÿæ¯äººä¸€ä»½ã€‚', type: 'holiday',
          options: [
              { text: 'è‡ªå·±è¡¥é’±', effects: { cohesion: 15, rep: 10, personalFunds: -100 } }, // ä¸ªäººèµ„äº§
              { text: 'æŒªç”¨ç­è´¹', effects: { cohesion: 8, rep: 3, funds: -80 } }, // ç­è´¹
              { text: 'åªå‘éƒ¨åˆ†', effects: { cohesion: -10, rep: -5 } },
              { text: 'å¹²è„†å…¨å½’æˆ‘äº†', effects: { personalFunds: 200, funds: -200, rep: -20, cohesion: -15 } } // ä¸ªäººå¾—é’±ï¼Œç­è´¹æŸå¤±
          ]},
        { id: 'hol2', title: 'å…ƒæ—¦æ™šä¼š', desc: 'å­¦æ ¡è¦æ±‚æ¯ä¸ªç­å‡†å¤‡èŠ‚ç›®ã€‚', type: 'holiday',
          options: [
              { text: 'ç²¾å¿ƒç»„ç»‡', effects: { cohesion: 20, rep: 15, energy: -20, funds: -150 } }, // ç­è´¹
              { text: 'ç®€å•åº”ä»˜', effects: { cohesion: 5, rep: 2, energy: -5 } },
              { text: 'ä¸å‚åŠ ', effects: { rep: -15, cohesion: -10 } },
              { text: 'èŠ±é’±è¯·å¤–æ´', effects: { cohesion: 10, rep: 5, funds: -200, personalFunds: 100 } } // ç­è´¹æ”¯å‡ºï¼Œä¸ªäººè´ªæ±¡
          ]},
        { id: 'hol3', title: 'æ¸…æ˜ç¥­æ‰«', desc: 'ç»„ç»‡å­¦ç”Ÿå»çƒˆå£«é™µå›­æ‰«å¢“ã€‚', type: 'holiday',
          options: [
              { text: 'è®¤çœŸç»„ç»‡', effects: { rep: 20, cohesion: 15, energy: -15, funds: -80 } }, // ç­è´¹
              { text: 'èµ°å½¢å¼', effects: { rep: 5, cohesion: 2, energy: -5 } },
              { text: 'ä¸ç»„ç»‡', effects: { rep: -10 } }
          ]},
        { id: 'hol4', title: 'æ˜¥èŠ‚æ‹œå¹´', desc: 'å‡ åå­¦ç”Ÿæ¥ä½ å®¶æ‹œå¹´ã€‚', type: 'holiday',
          options: [
              { text: 'çƒ­æƒ…æ‹›å¾…', effects: { cohesion: 15, rep: 10, personalFunds: -50, energy: -5 } }, // ä¸ªäºº
              { text: 'ç®€å•å›ç¤¼', effects: { cohesion: 5, rep: 3, personalFunds: -10 } }, // ä¸ªäºº
              { text: 'é¿è€Œä¸è§', effects: { cohesion: -10, rep: -5 } }
          ]},
        { id: 'hol5', title: 'å†¬è‡³åŒ…é¥ºå­', desc: 'ç­çº§ç»„ç»‡åŒ…é¥ºå­æ´»åŠ¨ã€‚', type: 'holiday',
          options: [
              { text: 'è‡ªå·±å‡ºé’±', effects: { cohesion: 15, rep: 8, personalFunds: -60, energy: -10 } }, // ä¸ªäºº
              { text: 'ç”¨ç­è´¹', effects: { cohesion: 10, rep: 5, funds: -80, energy: -10 } }, // ç­è´¹
              { text: 'è±¡å¾æ€§æ', effects: { cohesion: 3, energy: -3 } },
              { text: 'å€Ÿæœºè´ªæ±¡ç­è´¹', effects: { personalFunds: 30, funds: -50, cohesion: -5, rep: -3 } } // ä¸ªäººå¾—ï¼Œç­è´¹å¤±
          ]},
        // å­£èŠ‚å‰§æƒ…
        { id: 'sea1', title: 'ç§‹é›¨è¿ç»µ', desc: 'è¿æ—¥çš„é˜´é›¨è®©å­¦ç”Ÿä»¬æƒ…ç»ªä½è½ã€‚', type: 'season',
          options: [
              { text: 'ç»„ç»‡å®¤å†…æ´»åŠ¨', effects: { cohesion: 8, energy: -8, funds: -30 } }, // ç­è´¹
              { text: 'å¿ƒç†ç–å¯¼', effects: { cohesion: 5, energy: -10 } },
              { text: 'ä¸ç®¡', effects: { cohesion: -5, avgScore: -2 } }
          ]},
        { id: 'sea2', title: 'åˆé›ªé™ä¸´', desc: 'ç¬¬ä¸€åœºé›ªï¼Œå­¦ç”Ÿä»¬æ— å¿ƒå­¦ä¹ ã€‚', type: 'season',
          options: [
              { text: 'å…è®¸è¯¾é—´ç©é›ª', effects: { cohesion: 12, discipline: -5 } },
              { text: 'å¼ºè°ƒçºªå¾‹', effects: { discipline: 5, cohesion: -3 } },
              { text: 'ç»„ç»‡æ‰«é›ª', effects: { hygiene: 8, cohesion: 5, energy: -12 } } // æ— èµ„é‡‘å˜åŒ–
          ]},
        { id: 'sea3', title: 'æ˜¥æ¸¸è¸é’', desc: 'æ˜¥å¤©é€‚åˆæ˜¥æ¸¸ï¼Œå­¦æ ¡é¼“åŠ±ç­çº§æ´»åŠ¨ã€‚', type: 'season',
          options: [
              { text: 'ç²¾å¿ƒç»„ç»‡', effects: { cohesion: 15, rep: 10, funds: -100, energy: -15 } }, // ç­è´¹
              { text: 'ç®€å•é‡é¤', effects: { cohesion: 8, funds: -30, energy: -8 } }, // ç­è´¹
              { text: 'ä¸å‚åŠ ', effects: { cohesion: -8 } }
          ]},
        { id: 'sea4', title: 'å¤å¤œè‰é¸£', desc: 'é—·çƒ­çš„å¤œæ™šï¼Œå­¦ç”Ÿæµ®èºã€‚', type: 'season',
          options: [
              { text: 'ä¹°å†°æ£é™æ¸©', effects: { cohesion: 10, funds: -50, energy: -5 } }, // ç­è´¹
              { text: 'å»¶é•¿æ™šè‡ªä¹ ', effects: { avgScore: 3, cohesion: -5 } },
              { text: 'æ”¾å‡åŠå¤©', effects: { energy: 15, avgScore: -2 } }
          ]},
        { id: 'misc1', title: 'ç­è´¹çŸ­ç¼º', desc: 'ç­è´¹ä¸å¤Ÿä¹°è¿åŠ¨ä¼šç‰©èµ„ã€‚', type: 'moral',
          options: [
              { text: 'è‡ªå·±è¡¥è´´', effects: { cohesion: 10, rep: 8, personalFunds: -100, funds: 100 } }, // ä¸ªäººè½¬ç­è´¹
              { text: 'å¹²è„†åˆ«ä¹°äº†ï¼Œè¿™é’±å½’æˆ‘ä¸å°±è¡Œäº†', effects: { personalFunds: 100, funds: -100, rep: -15, cohesion: -5 } }, // ä¸ªäººå¾—ï¼Œç­è´¹å¤±
              { text: 'å‘å­¦æ ¡ç”³è¯·', effects: { rep: 5, energy: -10, funds: 50 } }
          ]},
        // å­¦ç”Ÿå¿ƒç†ç²¾ç¥é—®é¢˜
            { id: 'p1', title: 'å­¦ç”Ÿå¿ƒç†å±æœº', desc: 'ä¸€åå­¦ç”Ÿè¿‘æœŸæƒ…ç»ªä½è½ï¼Œå‡ºç°è‡ªæˆ‘æ€€ç–‘ï¼Œå¯èƒ½éœ€è¦ä¸“ä¸šå¹²é¢„ã€‚', type: 'psych',
              options: [
                  { text: 'è”ç³»å¿ƒç†å’¨è¯¢å¸ˆ', effects: { cohesion: 5, rep: 5, energy: -10, funds: -50 } }, // ç­è´¹
                  { text: 'ç§ä¸‹è°ˆå¿ƒ', effects: { cohesion: 8, energy: -12 }, psych: true },
                  { text: 'é€šçŸ¥å®¶é•¿', effects: [ { cohesion: 3, rep: 2, energy: -5 }, { cohesion: -10, rep: -5, avgScore: -3 } ] },
                  { text: 'å¿½è§†', effects: { cohesion: -15, avgScore: -5, rep: -5 } }
              ]},
            { id: 'p2', title: 'ç²¾ç¥ç–¾ç—…è‹—å¤´', desc: 'æœ‰å­¦ç”Ÿå‡ºç°å¼ºè¿«ç—‡çŠ¶ï¼Œé¢‘ç¹æ´—æ‰‹ï¼Œå½±å“å­¦ä¹ ã€‚', type: 'psych',
              options: [
                  { text: 'å»ºè®®å°±åŒ»', effects: { cohesion: 2, rep: 3, energy: -10, funds: -30 } }, // ç­è´¹
                  { text: 'å®‰æ’å¿ƒç†è¾…å¯¼', effects: { cohesion: 5, energy: -8 } },
                  { text: 'ä¸¥å‰æ‰¹è¯„', effects: { discipline: 3, cohesion: -20, rep: -5 } }
              ]},
            { id: 'p3', title: 'ç„¦è™‘è”“å»¶', desc: 'è€ƒè¯•ä¸´è¿‘ï¼Œç­é‡Œå¼¥æ¼«ç€ç„¦è™‘æƒ…ç»ªï¼Œå­¦ç”Ÿå¤±çœ å¢å¤šã€‚', type: 'psych',
              options: [
                  { text: 'å¼€å±•å‡å‹è®²åº§', effects: { cohesion: 10, avgScore: 2, energy: -10, funds: -20 } }, // ç­è´¹
                  { text: 'ä¸ªåˆ«è°ˆè¯', effects: { cohesion: 5, energy: -15 } },
                  { text: 'åŠ å¼ºè€ƒè¯•è®­ç»ƒ', effects: { avgScore: 5, cohesion: -10, rep: 2 } }
              ]},
            { id: 'p4', title: 'æŠ‘éƒå€¾å‘', desc: 'ä¸€åå­¦ç”Ÿçªç„¶ä¸§å¤±å­¦ä¹ å…´è¶£ï¼Œå¯¡è¨€å°‘è¯­ã€‚', type: 'psych',
              options: [
                  { text: 'ä¸“ä¸šå¿ƒç†å¹²é¢„', effects: { cohesion: 5, rep: 5, energy: -15, funds: -100 } }, // ç­è´¹
                  { text: 'è€å¿ƒé™ªä¼´', effects: { cohesion: 12, energy: -20, avgScore: -2 } },
                  { text: 'æš‚ç¼“å­¦ä¸š', effects: { cohesion: 3, avgScore: -5, rep: -2 } }
              ]},
            { id: 'p5', title: 'ç¤¾äº¤ææƒ§', desc: 'æœ‰å­¦ç”Ÿå®³æ€•é›†ä½“æ´»åŠ¨ï¼Œæ€»æ˜¯ç‹¬æ¥ç‹¬å¾€ã€‚', type: 'psych',
              options: [
                  { text: 'å®‰æ’åŒå­¦äº’åŠ©', effects: { cohesion: 8, energy: -6 } },
                  { text: 'é¼“åŠ±å‚åŠ ç¤¾å›¢', effects: { cohesion: 5, rep: 2, energy: -4 } },
                  { text: 'é¡ºå…¶è‡ªç„¶', effects: { cohesion: -5 } }
              ]},
            { id: 'p6', title: 'æ‰‹è‡‚ä¸Šçš„ä¼¤ç—•', desc: 'ä½ å‘ç°å­¦ç”Ÿå°æ—æ‰‹è‡‚ä¸Šæœ‰å‡ é“æ–°çš„åˆ’ç—•ï¼Œç–‘ä¼¼è‡ªæ®‹è¡Œä¸ºã€‚', type: 'psych',
              options: [
                  { text: 'ç«‹å³è”ç³»å¿ƒç†è€å¸ˆ', effects: { cohesion: 10, rep: 8, energy: -12, funds: 0 } },
                  { text: 'ç§ä¸‹æ¸©æŸ”è¯¢é—®', effects: { cohesion: 8, energy: -15 }, psych: true },
                  { text: 'é€šçŸ¥å®¶é•¿å¹¶å»ºè®®å°±åŒ»', effects: [ { cohesion: 5, rep: 5, avgScore: -1, energy: -10 }, { cohesion: -15, rep: -8, avgScore: -5, energy: -5 } ] },
                  { text: 'å‡è£…æ²¡çœ‹è§', effects: { cohesion: -30, avgScore: -10, rep: -15 } },
                  { text: 'å½“ä¼—æ–¥è´£', effects: { discipline: 5, cohesion: -40, avgScore: -8, rep: -20 } }
              ]},
            { id: 'p7', title: 'æ´»ç€æ²¡æ„æ€', desc: 'å­¦ç”Ÿå°é™ˆåœ¨ä½œæ–‡ä¸­æµéœ²å‡ºæ¶ˆæåŒä¸–çš„æƒ…ç»ªï¼Œä½ è¯»åååˆ†æ‹…å¿§ã€‚', type: 'psych',
              options: [
                  { text: 'ç´§æ€¥è”ç³»å¿ƒç†è€å¸ˆ', effects: { cohesion: 12, rep: 10, energy: -15, funds: 0 } },
                  { text: 'çº¦è°ˆå®¶é•¿', effects: [ { cohesion: 4, rep: 3, energy: -8 }, { cohesion: -12, rep: -6, avgScore: -2 } ] },
                  { text: 'é»˜é»˜æŒç»­å…³æ³¨', effects: { cohesion: 2, energy: -5 } },
                  { text: 'æ‰¹è¯„ä½œæ–‡å†…å®¹', effects: { avgScore: 2, cohesion: -20, rep: -10 } }
              ]},
            // ç­ä¸»ä»»å¿ƒç†é—®é¢˜äº‹ä»¶
            { id: 'tch1', title: 'èŒä¸šå€¦æ€ ', desc: 'é•¿æœŸé«˜å‹å·¥ä½œè®©ä½ æ„Ÿåˆ°ç–²æƒ«éº»æœ¨ï¼Œå¯¹å­¦ç”Ÿå¤±å»è€å¿ƒã€‚', type: 'teacher',
              options: [
                  { text: 'è¯·å‡ä¼‘æ¯', effects: { energy: 30, avgScore: -3, discipline: -2, cohesion: -2, rep: -2 } },
                  { text: 'å¯»æ±‚åŒäº‹æ”¯æŒ', effects: { energy: 10, cohesion: 5, rep: 2 } },
                  { text: 'ç¡¬æ’‘', effects: { energy: -20, cohesion: -5, avgScore: -2 } },
                  { text: 'å‘å­¦ç”Ÿå‘æ³„æƒ…ç»ª', effects: { energy: 5, cohesion: -20, rep: -15, avgScore: -5 } }
              ], teacherStateEffect: 'burnout'},
            { id: 'tch2', title: 'ç„¦è™‘å‘ä½œ', desc: 'ä½ çªç„¶æ„Ÿåˆ°å¿ƒæ…Œæ‰‹æŠ–ï¼Œéš¾ä»¥é›†ä¸­ç²¾åŠ›å·¥ä½œã€‚', type: 'teacher',
              options: [
                  { text: 'çœ‹åŒ»ç”Ÿ', effects: { energy: 20, personalFunds: -100, avgScore: -2 } }, // ä¸ªäºº
                  { text: 'è‡ªæˆ‘è°ƒèŠ‚', effects: { energy: 5, cohesion: 3 } },
                  { text: 'ç»§ç»­å·¥ä½œ', effects: { energy: -15, avgScore: -3, discipline: -2 } }
              ], teacherStateEffect: 'stressed'},
            { id: 'tch3', title: 'å¤±çœ å›°æ‰°', desc: 'ä½ å·²ç»è¿ç»­ä¸€å‘¨å¤±çœ ï¼Œç™½å¤©ç²¾ç¥ææƒšã€‚', type: 'teacher',
              options: [
                  { text: 'å°±åŒ»', effects: { energy: 25, personalFunds: -80, avgScore: -1 } }, // ä¸ªäºº
                  { text: 'å–å’–å•¡ç¡¬æ’‘', effects: { energy: 5, avgScore: -2, cohesion: -3 } },
                  { text: 'è¯·å‡è¡¥è§‰', effects: { energy: 40, avgScore: -4, discipline: -2 } }
              ], teacherStateEffect: 'tired'},
            { id: 'tch4', title: 'æŠ‘éƒæƒ…ç»ª', desc: 'ä½ å¼€å§‹æ€€ç–‘è‡ªå·±å½“ç­ä¸»ä»»çš„æ„ä¹‰ï¼Œæƒ…ç»ªæŒç»­ä½è½ã€‚', type: 'teacher',
              options: [
                  { text: 'å¯»æ±‚å¿ƒç†å’¨è¯¢', effects: { energy: 15, cohesion: 8, rep: 2, personalFunds: -150 } }, // ä¸ªäºº
                  { text: 'ä¸å®¶äººå€¾è¯‰', effects: { energy: 10, cohesion: 5 } },
                  { text: 'ç‹¬è‡ªæ‰¿å—', effects: { energy: -20, cohesion: -10, avgScore: -5 } },
                  { text: 'æ— æ•…æ‰¹è¯„å­¦ç”Ÿ', effects: { energy: 5, cohesion: -25, rep: -15, avgScore: -3 } }
              ], teacherStateEffect: 'depressed'},
            { id: 'm1', title: 'å­¦ç”Ÿé¡¶æ’', desc: 'å­¦ç”Ÿå°æåœ¨è¯¾å ‚ä¸Šå…¬å¼€é¡¶æ’ä½ ï¼Œè®©ä½ ä¸‹ä¸æ¥å°ã€‚', type: 'moral',
              options: [
                  { text: 'å†·é™æ²Ÿé€š', effects: { discipline: 5, cohesion: 3, rep: 2, energy: -5 } },
                  { text: 'è¯·å®¶é•¿', effects: [ { discipline: 8, cohesion: -2, rep: 3, energy: -6 }, { discipline: 2, cohesion: -10, rep: -5, energy: -8 } ] },
                  { text: 'ç½šç«™å¹¶è®­æ–¥', effects: { discipline: 10, cohesion: -15, rep: -3, energy: -3 } },
                  { text: 'äº‹åè°ˆå¿ƒ', effects: { cohesion: 10, rep: 5, avgScore: 1, energy: -10 } }
              ]},
            { id: 'm2', title: 'å­¦ç”Ÿå¿˜å¸¦ä½œä¸š', desc: 'è¯¾ä»£è¡¨å°èµµå¿˜å¸¦ä½œä¸šï¼Œè§£é‡Šè¯´æ˜¨æ™šå®¶é•¿åµæ¶æ²¡é¡¾ä¸Šã€‚', type: 'moral',
              options: [
                  { text: 'æŒ‰è§„å®šæ‰£åˆ†', effects: { discipline: 3, cohesion: -2, rep: 0 } },
                  { text: 'è°…è§£ä¸€æ¬¡', effects: { cohesion: 5, discipline: -2 } },
                  { text: 'å½“ä¼—ç¾è¾±', effects: { discipline: 5, cohesion: -20, rep: -5, avgScore: -2 } },
                  { text: 'ç§ä¸‹å®‰æ…°å¹¶è¡¥åš', effects: { cohesion: 8, avgScore: 2, energy: -4 } }
              ]},
            { id: 'm3', title: 'å­¦ç”Ÿè¯·ç—…å‡', desc: 'æœ‰å­¦ç”Ÿæ‹¿ç€ç—…å‡æ¡è¯·å‡ï¼Œä½†ä½ æ€€ç–‘å¯èƒ½æ˜¯å‡çš„ã€‚', type: 'moral',
              options: [
                  { text: 'å‡†å‡', effects: { cohesion: 3, rep: 2 } },
                  { text: 'æ‰“ç”µè¯æ ¸å®', effects: [ { rep: 2, energy: -4, cohesion: 1 }, { rep: -3, cohesion: -5, avgScore: -1 } ] },
                  { text: 'å½“åœºæ­ç©¿', effects: { discipline: 5, cohesion: -15, rep: -8 } },
                  { text: 'æ‰¹å‡†å¹¶å…³å¿ƒ', effects: { cohesion: 8, rep: 5, energy: -2 } }
              ]},
            { id: 'm4', title: 'å­¦ç”Ÿæˆç»©ä¸‹æ»‘', desc: 'ä¸€åå¹³æ—¶è®¤çœŸçš„å­¦ç”Ÿè¿‘æœŸæˆç»©ä¸‹æ»‘ï¼Œä½ äº†è§£åˆ°ä»–å®¶é‡Œæœ‰å˜æ•…ã€‚', type: 'moral',
              options: [
                  { text: 'ä¸¥å‰æ‰¹è¯„', effects: { avgScore: -2, discipline: 5, cohesion: -10 } },
                  { text: 'è°ˆå¿ƒé¼“åŠ±', effects: { cohesion: 10, avgScore: 3, energy: -8 } },
                  { text: 'å½“ä¼—ç‚¹å', effects: { avgScore: -5, cohesion: -15, rep: -5 } },
                  { text: 'è”ç³»å¿ƒç†è€å¸ˆå¸®æ‰¶', effects: { cohesion: 8, rep: 5, avgScore: 2, energy: -6, funds: -20 } } // ç­è´¹
              ]},
            { id: 'm5', title: 'å­¦ç”Ÿæƒ…ç»ªå´©æºƒ', desc: 'è¯¾é—´ä¸€åå¥³ç”Ÿçªç„¶å¤§å“­ï¼Œè¯´å‹åŠ›å¤ªå¤§å—ä¸äº†ã€‚', type: 'moral',
              options: [
                  { text: 'å®‰æ…°å¥¹', effects: { cohesion: 10, energy: -6 } },
                  { text: 'è¯·å¿ƒç†è€å¸ˆ', effects: { cohesion: 12, rep: 5, energy: -8, funds: -30 } }, // ç­è´¹
                  { text: 'è®©å¥¹å†·é™åˆ«å½±å“åˆ«äºº', effects: { cohesion: -20, rep: -10, avgScore: -2 } },
                  { text: 'é€šçŸ¥å®¶é•¿æ¥å›', effects: [ { cohesion: 5, rep: 3, energy: -4 }, { cohesion: -8, rep: -5, avgScore: -2 } ] }
              ]}
    ];
    
    const EXAM_EVENTS = [
        { id: 'exam1', title: 'æœŸä¸­è€ƒè¯•', desc: 'æœŸä¸­è€ƒè¯•ç»“æŸäº†ã€‚', options: [
            { text: 'åˆ†æé¼“åŠ±', effects: { avgScore: 3, cohesion: 5, rep: 3, energy: -8 } },
            { text: 'åªè¡¨æ‰¬å‰ä¸‰', effects: { avgScore: 1, cohesion: -3, rep: 2 } },
            { text: 'æ”¾å‡æ”¾æ¾', effects: { cohesion: 8, avgScore: -2, energy: 5 } }
        ]},
        { id: 'exam2', title: 'æœŸæœ«è€ƒè¯•', desc: 'æœŸæœ«è€ƒè¯•ç»“æŸã€‚', options: [
            { text: 'è¡¨å½°ä¼š', effects: { cohesion: 8, rep: 5, avgScore: 2, energy: -5 } },
            { text: 'å¸ƒç½®ä½œä¸š', effects: { avgScore: 3, cohesion: -2, rep: 2 } },
            { text: 'æå‰æ”¾å­¦', effects: { cohesion: 5, avgScore: -2, rep: -3 } }
        ]},
    ];
    
    const WEEKEND_ACTIVITIES = [
        { name: 'ç¤¾å›¢æ´»åŠ¨', effects: { cohesion: 6, energy: -8, funds: -20 } }, // ç­è´¹
        { name: 'è¾…å¯¼ç«èµ›', effects: { avgScore: 4, energy: -10, cohesion: 2 } }, // æ— èµ„é‡‘å˜åŒ– (ä¸ªäººä»˜å‡ºç²¾åŠ›)
        { name: 'å®¶è®¿', effects: [ { rep: 5, cohesion: 3, energy: -8, personalFunds: -20 }, { rep: -3, cohesion: -5, energy: -10, personalFunds: -10 } ] }, // ä¸ªäººèµ„äº§
        { name: 'å‘¨æœ«è‡ªä¹ ', effects: { avgScore: 3, discipline: 4, energy: -6 } }, // æ— èµ„é‡‘
        { name: 'ä¼‘æ¯', effects: { energy: 10 } },
    ];
    
    const VACATION_EVENTS = {
        winter: [
            { title: 'å¯’å‡ä½œä¸š', desc: 'ä½œä¸šå®Œæˆåº¦ä¸€èˆ¬ã€‚', options: [
                { text: 'çº¿ä¸Šç£ä¿ƒ', effects: { avgScore: 2, energy: -4 } },
                { text: 'é¡ºå…¶è‡ªç„¶', effects: { avgScore: -1 } }
            ]},
            { title: 'æ˜¥èŠ‚æ‹œå¹´', desc: 'æ˜¯å¦å®¶è®¿ï¼Ÿ', options: [
                { text: 'èµ°è®¿', effects: [ { cohesion: 5, rep: 5, personalFunds: -30 }, { cohesion: -2, rep: -5, personalFunds: -20 } ] }, // ä¸ªäºº
                { text: 'ç”µè¯', effects: { cohesion: 2, rep: 2, energy: -2 } }
            ]},
            { title: 'å‡æœŸçœ‹ç—…', desc: 'ä½ ç”Ÿç—…äº†ã€‚', options: [
                { text: 'ä¼‘å…»', effects: { energy: 20, avgScore: -2, cohesion: 2 } },
                { text: 'å¸¦ç—…å·¥ä½œ', effects: { energy: -15, avgScore: 2, rep: 3 } }
            ]}
        ],
        summer: [
            { title: 'ç¤¾ä¼šå®è·µ', desc: 'ç»„ç»‡å…¬ç›Šæ´»åŠ¨ã€‚', options: [
                { text: 'ç§¯æ', effects: { cohesion: 8, rep: 5, funds: -60, energy: -12 } }, // ç­è´¹
                { text: 'è‡ªç”±å‚åŠ ', effects: { cohesion: 2 } }
            ]},
            { title: 'ç½‘å§æ²‰è¿·', desc: 'å­¦ç”Ÿå¸¸å»ç½‘å§ã€‚', options: [
                { text: 'è­¦å‘Š', effects: { discipline: 5, cohesion: -3, energy: -5 } },
                { text: 'è”ç³»å®¶é•¿', effects: [ { rep: 4, cohesion: 2, energy: -6 }, { rep: -5, cohesion: -8, energy: -8 } ] }
            ]},
            { title: 'å‡æœŸçœ‹ç—…', desc: 'ä½ ç”Ÿç—…äº†ã€‚', options: [
                { text: 'ä¼‘å…»', effects: { energy: 20, avgScore: -2, cohesion: 2 } },
                { text: 'å¸¦ç—…å·¥ä½œ', effects: { energy: -15, avgScore: 2, rep: 3 } }
            ]}
        ]
    };
    
    const LOW_STAT_EVENTS = [
        { id: 'low1', title: 'ç²¾åŠ›é€æ”¯', desc: 'ä½ ç—…å€’äº†ï¼Œéœ€è¦ä¼‘æ¯ä¸€å‘¨ã€‚', stat: 'energy', threshold: 0,
          options: [ { text: 'å¼ºåˆ¶ä¼‘æ¯', effects: { energy: 30, avgScore: -5, cohesion: -3, rep: -2 }, skipWeek: true } ] },
        { id: 'low2', title: 'çºªå¾‹å´©å', desc: 'ç­çº§è¢«é€šæŠ¥æ‰¹è¯„ã€‚', stat: 'discipline', threshold: 15,
          options: [ { text: 'æ•´é¡¿', effects: { discipline: 10, energy: -15, cohesion: -3 } } ] },
    ];
    
    const BASE_STATS = {
        avgScore: 50, discipline: 50, hygiene: 50, cohesion: 50, rep: 50, funds: 200, personalFunds: 500,
        energy: 100, maxEnergy: 100
    };
    
    const PLAYER_STATE_EFFECTS = {
        tired: { name: 'ç–²æƒ«', desc: 'ç²¾åŠ›æ¢å¤-5/å±‚' },
        stressed: { name: 'å‹åŠ›å¤§', desc: 'å¿ƒç†äº‹ä»¶æ¦‚ç‡+20%/å±‚' },
        burnout: { name: 'èŒä¸šå€¦æ€ ', desc: 'äº‹ä»¶æ•ˆæœ-10%/å±‚ï¼Œç²¾åŠ›æ¢å¤-10/å±‚' },
        depressed: { name: 'æŠ‘éƒå€¾å‘', desc: 'æ¯å‘¨è‡ªåŠ¨-5ç²¾åŠ›/å±‚ï¼Œ-3å‡èšåŠ›/å±‚' }
    };
    
    // èƒŒæ™¯è‰²å‡½æ•°
    function getBackgroundColor(state) {
        const sem = state.currentSemester;
        if (!sem) return '#f3e9ff';
        const grade = sem.grade;
        const season = sem.season;
        // åŸºç¡€è‰²è°ƒï¼šé«˜ä¸€ä¸Šæµ…ç´«ï¼Œé«˜ä¸€ä¸‹äº®ç´«ï¼Œé«˜äºŒä¸Šä¸­ç´«ï¼Œé«˜äºŒä¸‹æ·±ç´«ï¼Œé«˜ä¸‰ä¸Šç°ç´«ï¼Œé«˜ä¸‰ä¸‹æš—ç´«
        const colors = [
            '#f3e9ff', // é«˜ä¸€ä¸Š
            '#e6d9ff', // é«˜ä¸€ä¸‹
            '#d9ccff', // é«˜äºŒä¸Š
            '#ccbfff', // é«˜äºŒä¸‹
            '#bfb2f0', // é«˜ä¸‰ä¸Š
            '#b2a5e0'  // é«˜ä¸‰ä¸‹
        ];
        let idx = grade * 2 + (season === 'ä¸Š' ? 0 : 1);
        idx = Math.min(idx, colors.length-1);
        let base = colors[idx];
        // å åŠ çŠ¶æ€å‹æŠ‘æ„Ÿï¼šå¦‚æœç©å®¶çŠ¶æ€æœ‰è´Ÿé¢ï¼Œç¨å¾®é™ä½äº®åº¦
        if (state.playerStates.some(s => ['burnout','depressed'].includes(s.type))) {
            base = '#c2b0e0';
        }
        return base;
    }
    
    // ---------- å…¨å±€çŠ¶æ€ ----------
    let gameState = {
        semesterId: 'g1s1', classType: 'normal', subject: 'ç‰©ç†', personality: 'gentle', difficulty: 'normal',
        talents: [], currentSemester: null, week: 0, totalWeeks: 0, stats: { ...BASE_STATS }, log: [],
        gamePhase: 'setup', vacationWeek: 0, vacationType: 'summer', completedSemesters: [], skipWeek: false,
        playerStates: [], achievements: [],
    };
    let currentDetail = { type: null, data: null };
    
    function addLog(msg) { gameState.log.unshift(`ç¬¬${gameState.week}å‘¨: ${msg}`); if (gameState.log.length > 12) gameState.log.pop(); }
    function getStateLevel(type) { const s = gameState.playerStates.find(s => s.type === type); return s ? s.level : 0; }
    function addPlayerState(type, level = 1) {
        const ex = gameState.playerStates.find(s => s.type === type);
        ex ? ex.level += level : gameState.playerStates.push({ type, level });
    }
    
    function adjustEventWeight(event) {
        let w = 1;
        const diff = DIFFICULTY[gameState.difficulty];
        if (event.type === 'contest' || event.type === 'club' || event.type === 'sports') w *= diff.posEventMod;
        if (event.options.some(o => o.effects && typeof o.effects === 'object' && (o.effects.rep < 0 || o.effects.cohesion < -3))) w *= diff.negEventMod;
        if (event.type === 'psych' || event.type === 'teacher' || event.type === 'moral' || event.type === 'holiday' || event.type === 'season') {
            w *= 1 + 0.2 * getStateLevel('stressed');
            if (gameState.stats.cohesion < 40) w *= 1.3;
            if (gameState.stats.energy < 30) w *= 1.2;
        }
        return w;
    }
    
    function pickRandomEvent() {
        if (Math.random() < 0.1) {
            const teacher = BASE_EVENTS.filter(e => e.type === 'teacher');
            if (teacher.length) return teacher[Math.floor(Math.random() * teacher.length)];
        }
        const pool = BASE_EVENTS.filter(e => e.type !== 'teacher' && e.type !== 'exam');
        const weights = pool.map(e => adjustEventWeight(e));
        const total = weights.reduce((a,b)=>a+b,0);
        let r = Math.random() * total;
        for (let i=0; i<pool.length; i++) { r -= weights[i]; if (r<=0) return pool[i]; }
        return pool[0];
    }
    
    function checkLowStatEvent() {
        if (gameState.skipWeek) return null;
        for (let ev of LOW_STAT_EVENTS) {
            if (gameState.stats[ev.stat] < ev.threshold) return ev;
        }
        return null;
    }
    
    function weeklyDecay() {
        let mult = 1 - 0.1 * getStateLevel('burnout');
        gameState.stats.avgScore = Math.max(0, gameState.stats.avgScore - 1 * mult);
        gameState.stats.discipline = Math.max(0, gameState.stats.discipline - 1 * mult);
        gameState.stats.hygiene = Math.max(0, gameState.stats.hygiene - 1 * mult);
        gameState.stats.cohesion = Math.max(0, gameState.stats.cohesion - 1 * mult);
        gameState.stats.rep = Math.max(0, gameState.stats.rep - 1 * mult);
        let rec = 15 - 5 * getStateLevel('tired') - 10 * getStateLevel('burnout');
        gameState.stats.energy = Math.min(gameState.stats.maxEnergy, gameState.stats.energy + rec);
        let dep = getStateLevel('depressed');
        if (dep) { gameState.stats.energy -= dep * 5; gameState.stats.cohesion -= dep * 3; }
        if (gameState.talents.includes('t2')) gameState.stats.cohesion = Math.min(100, gameState.stats.cohesion + 2);
    }
    
    function checkAchievements() {
        if (gameState.difficulty !== 'reality') return;
        if (gameState.week === 5 && gameState.stats.discipline > 60 && !gameState.achievements.some(a=>a.name==='çºªå¾‹ä¹‹æ˜Ÿ')) {
            gameState.achievements.push({ name: 'çºªå¾‹ä¹‹æ˜Ÿ', desc: 'è¿ç»­5å‘¨çºªå¾‹è‰¯å¥½', time: gameState.week });
            alert('æˆå°±è§£é”ï¼šçºªå¾‹ä¹‹æ˜Ÿ'); addLog('ğŸ‰ æˆå°±ï¼šçºªå¾‹ä¹‹æ˜Ÿ');
        }
        if (gameState.stats.avgScore >= 80 && !gameState.achievements.some(a=>a.name==='å­¦éœ¸ç­')) {
            gameState.achievements.push({ name: 'å­¦éœ¸ç­', desc: 'å¹³å‡åˆ†è¾¾åˆ°80', time: gameState.week });
            alert('æˆå°±è§£é”ï¼šå­¦éœ¸ç­'); addLog('ğŸ‰ æˆå°±ï¼šå­¦éœ¸ç­');
        }
    }
    
    function randomizeTalentsForReality() {
        let shuffled = [...TALENT_LIBRARY].sort(()=>0.5-Math.random());
        let selected = [], total = 0;
        for (let t of shuffled) {
            if (selected.length >= 4) break;
            if (total + t.point <= 2 && total + t.point >= -2) { selected.push(t.id); total += t.point; }
        }
        return selected;
    }
    
    function getLevelText(v, t) {
        if (t === 'energy') { if (v>=80) return 'å……æ²›'; if (v>=60) return 'æ­£å¸¸'; if (v>=30) return 'ç–²æƒ«'; return 'é€æ”¯'; }
        if (v>=85) return 'ä¼˜ç§€'; if (v>=70) return 'è‰¯å¥½'; if (v>=55) return 'ä¸­ç­‰'; if (v>=40) return 'è¾ƒå·®'; return 'å±é™©';
    }
    
    function render() {
        const container = document.getElementById('gameContainer');
        // åŠ¨æ€èƒŒæ™¯è‰²
        container.style.backgroundColor = getBackgroundColor(gameState);
        if (gameState.gamePhase === 'setup') { container.innerHTML = renderSetupDifficulty(); attachSetupDifficultyListeners(); }
        else if (gameState.gamePhase === 'setupTalents') { container.innerHTML = renderSetupTalents(); attachSetupTalentsListeners(); }
        else if (gameState.gamePhase === 'playing') { container.innerHTML = renderPlaying(); attachPlayingListeners(); }
        else if (gameState.gamePhase === 'weekend') { container.innerHTML = renderWeekend(); attachWeekendListeners(); }
        else if (gameState.gamePhase === 'vacation') { container.innerHTML = renderVacation(); attachVacationListeners(); }
        else if (gameState.gamePhase === 'ended') { container.innerHTML = renderEnding(); attachEndingListeners(); }
    }
    
    // ---------- ç•Œé¢æ¸²æŸ“å‡½æ•° ----------
    function renderSetupDifficulty() {
        return `
            <div class="header"><h2>âš™ï¸ ç¬¬ä¸€æ­¥ï¼šåŸºç¡€é…ç½®</h2></div>
            <div style="padding:30px">
                <div class="select-row">
                    <select id="semesterSelect">${SEMESTERS.map(s=>`<option value="${s.id}" ${gameState.semesterId===s.id?'selected':''}>${s.label}</option>`).join('')}</select>
                    <select id="classSelect">${Object.entries(CLASS_TYPES).map(([k,v])=>`<option value="${k}" ${gameState.classType===k?'selected':''}>${v.name}</option>`).join('')}</select>
                </div>
                <div class="select-row">
                    <select id="subjectSelect">${CLASS_TYPES[gameState.classType].allowSubjects.map(sub=>`<option value="${sub}" ${gameState.subject===sub?'selected':''}>${sub}</option>`).join('')}</select>
                    <select id="personalitySelect">${Object.entries(PERSONALITY).map(([k,v])=>`<option value="${k}" ${gameState.personality===k?'selected':''}>${v.name}</option>`).join('')}</select>
                </div>
                <div class="select-row">
                    <select id="difficultySelect">${Object.entries(DIFFICULTY).map(([k,v])=>`<option value="${k}" ${gameState.difficulty===k?'selected':''}>${v.name}</option>`).join('')}</select>
                </div>
                <button class="btn" id="nextStepBtn">ä¸‹ä¸€æ­¥ï¼šå¤©èµ‹</button>
            </div>
        `;
    }
    function attachSetupDifficultyListeners() {
        document.getElementById('semesterSelect')?.addEventListener('change', e => gameState.semesterId = e.target.value);
        document.getElementById('classSelect')?.addEventListener('change', e => { gameState.classType = e.target.value; render(); });
        document.getElementById('subjectSelect')?.addEventListener('change', e => gameState.subject = e.target.value);
        document.getElementById('personalitySelect')?.addEventListener('change', e => gameState.personality = e.target.value);
        document.getElementById('difficultySelect')?.addEventListener('change', e => gameState.difficulty = e.target.value);
        document.getElementById('nextStepBtn')?.addEventListener('click', () => {
            gameState.gamePhase = 'setupTalents';
            gameState.talents = gameState.difficulty === 'reality' ? randomizeTalentsForReality() : [];
            render();
        });
    }
    
    function renderSetupTalents() {
        const isReality = gameState.difficulty === 'reality';
        const pointRequire = DIFFICULTY[gameState.difficulty].pointRequire;
        let talents = sessionStorage.getItem('setupTalents') ? JSON.parse(sessionStorage.getItem('setupTalents')).map(id=>TALENT_LIBRARY.find(t=>t.id===id)) : (()=>{
            let shuffled = [...TALENT_LIBRARY].sort(()=>0.5-Math.random()).slice(0,6);
            sessionStorage.setItem('setupTalents', JSON.stringify(shuffled.map(t=>t.id)));
            return shuffled;
        })();
        const total = gameState.talents.reduce((s,id)=>{let t=TALENT_LIBRARY.find(tt=>tt.id===id); return s+(t?t.point:0);},0);
        return `
            <div class="header"><h2>âš™ï¸ ç¬¬äºŒæ­¥ï¼šå¤©èµ‹é€‰æ‹©</h2></div>
            <div style="padding:30px">
                <h3 style="color:#2a1b4a">å½“å‰éš¾åº¦: ${DIFFICULTY[gameState.difficulty].name} (è¦æ±‚â‰¥${pointRequire})</h3>
                <div class="talent-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin:20px 0">
                    ${talents.map(t=>{
                        let sel = gameState.talents.includes(t.id) ? 'selected' : '';
                        return `<div class="talent-card ${sel}" data-talent-id="${t.id}" style="background:rgba(200,170,255,0.5); border-radius:30px; padding:15px; border:2px solid ${sel?'#b38aff':'transparent'}">
                            <div><strong>${t.name}</strong> <span style="color:${t.point<0?'#3a7a3a':'#b34a4a'}">${t.point>0?'+'+t.point:t.point}</span></div>
                            <div style="font-size:0.8rem">${t.desc}</div>
                        </div>`;
                    }).join('')}
                </div>
                <div style="color:#2a1b4a; font-size:1.3rem; margin:20px 0">å½“å‰æ€»å¤©èµ‹ç‚¹: ${total} (è¦æ±‚â‰¥${pointRequire})</div>
                <div style="display:flex; gap:15px">
                    <button class="btn secondary" id="backBtn">è¿”å›</button>
                    <button class="btn" id="randomizeTalentsBtn" ${isReality?'disabled':''}>åˆ·æ–°å¤©èµ‹</button>
                    <button class="btn" id="startGameBtn">å¼€å§‹æ¸¸æˆ</button>
                </div>
            </div>
        `;
    }
    function attachSetupTalentsListeners() {
        const isReality = gameState.difficulty === 'reality';
        if (!isReality) {
            document.querySelectorAll('.talent-card').forEach(c => c.addEventListener('click', ()=>{
                const id = c.dataset.talentId;
                if (gameState.talents.includes(id)) gameState.talents = gameState.talents.filter(t=>t!==id);
                else gameState.talents.push(id);
                render();
            }));
        }
        document.getElementById('backBtn')?.addEventListener('click', ()=>{ gameState.gamePhase='setup'; render(); });
        document.getElementById('randomizeTalentsBtn')?.addEventListener('click', ()=>{ sessionStorage.removeItem('setupTalents'); gameState.talents=[]; render(); });
        document.getElementById('startGameBtn')?.addEventListener('click', ()=>{
            const sem = SEMESTERS.find(s=>s.id===gameState.semesterId);
            gameState.currentSemester = sem;
            gameState.week = 1; gameState.totalWeeks = sem.weeks;
            const ct = CLASS_TYPES[gameState.classType];
            gameState.stats = { ...BASE_STATS, avgScore: BASE_STATS.avgScore+(ct.avgScore||0), discipline: BASE_STATS.discipline+(ct.discipline||0), hygiene: BASE_STATS.hygiene+(ct.hygiene||0), cohesion: BASE_STATS.cohesion+(ct.cohesion||0), rep: BASE_STATS.rep+(ct.rep||0), funds: BASE_STATS.funds, personalFunds: BASE_STATS.personalFunds, energy: BASE_STATS.energy, maxEnergy: BASE_STATS.maxEnergy };
            if (gameState.talents.includes('t12')) { gameState.stats.maxEnergy -= 10; gameState.stats.energy = Math.min(gameState.stats.energy, gameState.stats.maxEnergy); }
            gameState.log = ['æ¸¸æˆå¼€å§‹ï¼']; gameState.gamePhase = 'playing';
            sessionStorage.removeItem('setupTalents'); render();
        });
    }
    
    function renderPlaying() {
        const sem = gameState.currentSemester;
        const stats = gameState.stats;
        let event;
        if (!gameState.skipWeek) {
            const low = checkLowStatEvent();
            if (low) { event = low; if (low.id==='low1') gameState.skipWeek=true; }
            else if (gameState.week >= gameState.totalWeeks) event = EXAM_EVENTS[Math.floor(Math.random()*EXAM_EVENTS.length)];
            else event = pickRandomEvent();
        } else { event = LOW_STAT_EVENTS.find(e=>e.id==='low1'); gameState.skipWeek=false; }
        gameState.currentEvent = event;
    
        const optionsHtml = event.options.map((opt,i)=>`<button class="option-btn" data-opt-index="${i}" ${opt.personality && opt.personality!==gameState.personality?'disabled':''}>${opt.text}</button>`).join('');
    
        const stateTags = gameState.playerStates.map(s=>`<span class="status-item" data-state="${s.type}">${PLAYER_STATE_EFFECTS[s.type].name}${s.level>1?' x'+s.level:''}</span>`).join('');
        const achievementTags = gameState.achievements.map(a=>`<span class="achievement-tag" data-achievement="${a.name}">${a.name}</span>`).join('');
        const talentTags = gameState.talents.map(id=>{let t=TALENT_LIBRARY.find(tt=>tt.id===id); return t?`<span class="talent-tag" data-talent="${t.id}">${t.name}</span>`:''}).join('');
    
        let detailHtml = '<div class="detail-title">ç‚¹å‡»æ ‡ç­¾æŸ¥çœ‹è¯¦æƒ…</div><div class="detail-content">â€”</div>';
        if (currentDetail.type==='state') { let s=PLAYER_STATE_EFFECTS[currentDetail.data]; detailHtml=`<div class="detail-title">çŠ¶æ€ï¼š${s.name}</div><div class="detail-content">${s.desc}</div>`; }
        else if (currentDetail.type==='achievement') { let a=gameState.achievements.find(a=>a.name===currentDetail.data); if(a) detailHtml=`<div class="detail-title">æˆå°±ï¼š${a.name}</div><div class="detail-content">${a.desc} (ç¬¬${a.time}å‘¨)</div>`; }
        else if (currentDetail.type==='talent') { let t=TALENT_LIBRARY.find(tt=>tt.id===currentDetail.data); if(t) detailHtml=`<div class="detail-title">å¤©èµ‹ï¼š${t.name}</div><div class="detail-content">${t.desc}</div>`; }
    
        return `
            <div class="header">
                <h2>${gameState.subject} Â· ${sem.label} 16ç­</h2>
                <span class="badge">ç¬¬ ${gameState.week}/${gameState.totalWeeks} å‘¨</span>
            </div>
            <div class="main-row">
                <div class="left-col">
                    <div class="stats-panel">
                        <div class="stat-item"><span class="stat-label">å¹³å‡åˆ†</span><span class="stat-value">${getLevelText(stats.avgScore)}</span></div>
                        <div class="stat-item"><span class="stat-label">çºªå¾‹</span><span class="stat-value">${getLevelText(stats.discipline)}</span></div>
                        <div class="stat-item"><span class="stat-label">å«ç”Ÿ</span><span class="stat-value">${getLevelText(stats.hygiene)}</span></div>
                        <div class="stat-item"><span class="stat-label">å‡èšåŠ›</span><span class="stat-value">${getLevelText(stats.cohesion)}</span></div>
                        <div class="stat-item"><span class="stat-label">å£°æœ›</span><span class="stat-value">${getLevelText(stats.rep)}</span></div>
                        <div class="stat-item"><span class="stat-label">ç²¾åŠ›</span><span class="stat-value ${stats.energy<0?'warning':''}">${getLevelText(stats.energy,'energy')}</span></div>
                        <div class="stat-item"><span class="stat-label">ç­è´¹</span><span class="stat-value">${stats.funds}</span></div>
                        <div class="stat-item"><span class="stat-label">ä¸ªäºº</span><span class="stat-value">${stats.personalFunds}</span></div>
                    </div>
                    <div class="status-bar">${stateTags || '<span>æ— çŠ¶æ€</span>'}</div>
                    <div class="log-area">${gameState.log.map(l=>`<div class="log-entry">${l}</div>`).join('')}</div>
                </div>
                <div class="right-col">
                    <div class="event-area">
                        <div class="event-title">${event.title}</div>
                        <div class="event-desc">${event.desc}</div>
                        <div class="option-buttons" id="eventOptions">${optionsHtml}</div>
                    </div>
                    <div class="talent-view"><h4>âœ¨å¤©èµ‹</h4>${talentTags||'æ— '}</div>
                    <div class="talent-view"><h4>ğŸ†æˆå°±</h4>${achievementTags||'æ— '}</div>
                    <div class="detail-panel">${detailHtml}</div>
                </div>
            </div>
            <div class="control-bar"><button class="btn secondary" id="newGameBtn">è€å­ä¸å¹²äº†</button></div>
        `;
    }
    
    function attachPlayingListeners() {
        document.querySelectorAll('#eventOptions .option-btn').forEach(btn=>btn.addEventListener('click',e=>{
            let idx = e.target.dataset.optIndex;
            let opt = gameState.currentEvent.options[idx];
            let eff = Array.isArray(opt.effects) ? opt.effects[Math.floor(Math.random()*opt.effects.length)] : opt.effects;
            for (let [k,v] of Object.entries(eff)) {
                if (k==='energy') gameState.stats.energy += v;
                else if (k==='funds') gameState.stats.funds += v;
                else if (k==='personalFunds') gameState.stats.personalFunds += v;
                else if (k in gameState.stats) gameState.stats[k] = Math.min(100, Math.max(-100, gameState.stats[k] + v));
            }
            addLog(`é€‰æ‹©äº†ã€Œ${opt.text}ã€`);
            if (opt.teacherStateEffect) addPlayerState(opt.teacherStateEffect, 1);
            if (gameState.week >= gameState.totalWeeks) finishSemester();
            else gameState.gamePhase = 'weekend';
            render();
        }));
        document.querySelectorAll('.status-item[data-state]').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'state',data:el.dataset.state}; render(); }));
        document.querySelectorAll('.achievement-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'achievement',data:el.dataset.achievement}; render(); }));
        document.querySelectorAll('.talent-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'talent',data:el.dataset.talent}; render(); }));
        document.getElementById('newGameBtn')?.addEventListener('click',()=>{ if(confirm('é‡æ–°å¼€å§‹ï¼Ÿ')) resetGame(); });
    }
    
    function finishSemester() {
        gameState.completedSemesters.push(gameState.currentSemester.id);
        gameState.vacationType = gameState.currentSemester.season === 'ä¸Š' ? 'winter' : 'summer';
        gameState.vacationWeek = 1;
        addLog('å­¦æœŸç»“æŸï¼Œè¿›å…¥å‡æœŸ');
        gameState.gamePhase = 'vacation';
        gameState.stats.energy = Math.min(gameState.stats.maxEnergy, gameState.stats.energy + 10);
        checkAchievements();
    }
    
    function renderWeekend() {
        const stats = gameState.stats;
        const activities = WEEKEND_ACTIVITIES.map((act, idx) => {
            let eff = act.effects;
            let energyChange = Array.isArray(eff) ? eff[0].energy : (eff.energy || 0);
            return `<button class="option-btn" data-act-index="${idx}">${act.name} (ç²¾åŠ› ${energyChange<0?energyChange:'+'+energyChange})</button>`;
        }).join('');
        const stateTags = gameState.playerStates.map(s=>`<span class="status-item" data-state="${s.type}">${PLAYER_STATE_EFFECTS[s.type].name}${s.level>1?' x'+s.level:''}</span>`).join('');
        const achievementTags = gameState.achievements.map(a=>`<span class="achievement-tag" data-achievement="${a.name}">${a.name}</span>`).join('');
        const talentTags = gameState.talents.map(id=>{let t=TALENT_LIBRARY.find(tt=>tt.id===id); return t?`<span class="talent-tag" data-talent="${t.id}">${t.name}</span>`:''}).join('');
        let detailHtml = '<div class="detail-title">ç‚¹å‡»æ ‡ç­¾æŸ¥çœ‹è¯¦æƒ…</div><div class="detail-content">â€”</div>';
        if (currentDetail.type==='state') { let s=PLAYER_STATE_EFFECTS[currentDetail.data]; detailHtml=`<div class="detail-title">çŠ¶æ€ï¼š${s.name}</div><div class="detail-content">${s.desc}</div>`; }
        else if (currentDetail.type==='achievement') { let a=gameState.achievements.find(a=>a.name===currentDetail.data); if(a) detailHtml=`<div class="detail-title">æˆå°±ï¼š${a.name}</div><div class="detail-content">${a.desc} (ç¬¬${a.time}å‘¨)</div>`; }
        else if (currentDetail.type==='talent') { let t=TALENT_LIBRARY.find(tt=>tt.id===currentDetail.data); if(t) detailHtml=`<div class="detail-title">å¤©èµ‹ï¼š${t.name}</div><div class="detail-content">${t.desc}</div>`; }
        return `
            <div class="header">
                <h2>å‘¨æœ« Â· ç¬¬${gameState.week}å‘¨</h2>
                <span class="badge">ç²¾åŠ› ${getLevelText(stats.energy,'energy')}</span>
            </div>
            <div class="main-row">
                <div class="left-col">
                    <div class="stats-panel" style="grid-template-columns:repeat(4,1fr)">
                        <div class="stat-item"><span class="stat-label">å¹³å‡åˆ†</span><span>${getLevelText(stats.avgScore)}</span></div>
                        <div class="stat-item"><span class="stat-label">å‡èšåŠ›</span><span>${getLevelText(stats.cohesion)}</span></div>
                        <div class="stat-item"><span class="stat-label">å£°æœ›</span><span>${getLevelText(stats.rep)}</span></div>
                        <div class="stat-item"><span class="stat-label">ç­è´¹/ä¸ªäºº</span><span>${stats.funds}/${stats.personalFunds}</span></div>
                    </div>
                    <div class="status-bar">${stateTags || '<span>æ— çŠ¶æ€</span>'}</div>
                    <div class="log-area">${gameState.log.map(l=>`<div class="log-entry">${l}</div>`).join('')}</div>
                </div>
                <div class="right-col">
                    <div class="event-area">
                        <div class="event-title">å‘¨æœ«åšä»€ä¹ˆï¼Ÿ</div>
                        <div class="event-desc">ä½ å¯ä»¥åˆ©ç”¨å‘¨æœ«å¤„ç†ç­çº§äº‹åŠ¡ï¼Œæˆ–è€…ä¼‘æ¯æ¢å¤ç²¾åŠ›ã€‚</div>
                        <div class="option-buttons" id="weekendOptions">${activities}</div>
                    </div>
                    <div class="talent-view"><h4>âœ¨å¤©èµ‹</h4>${talentTags||'æ— '}</div>
                    <div class="talent-view"><h4>ğŸ†æˆå°±</h4>${achievementTags||'æ— '}</div>
                    <div class="detail-panel">${detailHtml}</div>
                </div>
            </div>
            <div class="control-bar"><button class="btn secondary" id="newGameBtn">è€å­ä¸å¹²äº†</button></div>
        `;
    }
    
    function attachWeekendListeners() {
        document.querySelectorAll('#weekendOptions .option-btn').forEach(btn=>btn.addEventListener('click',e=>{
            let idx = e.target.dataset.actIndex;
            let act = WEEKEND_ACTIVITIES[idx];
            let eff = Array.isArray(act.effects) ? act.effects[Math.floor(Math.random()*act.effects.length)] : act.effects;
            for (let [k,v] of Object.entries(eff)) {
                if (k==='energy') gameState.stats.energy += v;
                else if (k==='funds') gameState.stats.funds += v;
                else if (k==='personalFunds') gameState.stats.personalFunds += v;
                else if (k in gameState.stats) gameState.stats[k] = Math.min(100, Math.max(-100, gameState.stats[k] + v));
            }
            addLog(`å‘¨æœ«ï¼š${act.name}`);
            weeklyDecay();
            gameState.week++;
            if (gameState.week > gameState.totalWeeks) finishSemester();
            else gameState.gamePhase = 'playing';
            checkAchievements();
            render();
        }));
        document.querySelectorAll('.status-item[data-state]').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'state',data:el.dataset.state}; render(); }));
        document.querySelectorAll('.achievement-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'achievement',data:el.dataset.achievement}; render(); }));
        document.querySelectorAll('.talent-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'talent',data:el.dataset.talent}; render(); }));
        document.getElementById('newGameBtn')?.addEventListener('click',()=>{ if(confirm('é‡æ–°å¼€å§‹ï¼Ÿ')) resetGame(); });
    }
    
    function renderVacation() {
        const vacEvents = VACATION_EVENTS[gameState.vacationType];
        const eventIdx = (gameState.vacationWeek - 1) % vacEvents.length;
        const event = vacEvents[eventIdx];
        const optionsHtml = event.options.map((opt,i)=>`<button class="option-btn" data-opt-index="${i}">${opt.text}</button>`).join('');
        const stateTags = gameState.playerStates.map(s=>`<span class="status-item" data-state="${s.type}">${PLAYER_STATE_EFFECTS[s.type].name}${s.level>1?' x'+s.level:''}</span>`).join('');
        const achievementTags = gameState.achievements.map(a=>`<span class="achievement-tag" data-achievement="${a.name}">${a.name}</span>`).join('');
        const talentTags = gameState.talents.map(id=>{let t=TALENT_LIBRARY.find(tt=>tt.id===id); return t?`<span class="talent-tag" data-talent="${t.id}">${t.name}</span>`:''}).join('');
        let detailHtml = '<div class="detail-title">ç‚¹å‡»æ ‡ç­¾æŸ¥çœ‹è¯¦æƒ…</div><div class="detail-content">â€”</div>';
        if (currentDetail.type==='state') { let s=PLAYER_STATE_EFFECTS[currentDetail.data]; detailHtml=`<div class="detail-title">çŠ¶æ€ï¼š${s.name}</div><div class="detail-content">${s.desc}</div>`; }
        else if (currentDetail.type==='achievement') { let a=gameState.achievements.find(a=>a.name===currentDetail.data); if(a) detailHtml=`<div class="detail-title">æˆå°±ï¼š${a.name}</div><div class="detail-content">${a.desc} (ç¬¬${a.time}å‘¨)</div>`; }
        else if (currentDetail.type==='talent') { let t=TALENT_LIBRARY.find(tt=>tt.id===currentDetail.data); if(t) detailHtml=`<div class="detail-title">å¤©èµ‹ï¼š${t.name}</div><div class="detail-content">${t.desc}</div>`; }
        return `
            <div class="header">
                <h2>${gameState.vacationType==='winter'?'â„ï¸ å¯’å‡':'â˜€ï¸ æš‘å‡'} ç¬¬${gameState.vacationWeek}/3å‘¨</h2>
            </div>
            <div class="main-row">
                <div class="left-col">
                    <div class="stats-panel" style="grid-template-columns:repeat(4,1fr)">
                        <div class="stat-item"><span class="stat-label">å¹³å‡åˆ†</span><span>${getLevelText(gameState.stats.avgScore)}</span></div>
                        <div class="stat-item"><span class="stat-label">å‡èšåŠ›</span><span>${getLevelText(gameState.stats.cohesion)}</span></div>
                        <div class="stat-item"><span class="stat-label">å£°æœ›</span><span>${getLevelText(gameState.stats.rep)}</span></div>
                        <div class="stat-item"><span class="stat-label">ç­è´¹/ä¸ªäºº</span><span>${gameState.stats.funds}/${gameState.stats.personalFunds}</span></div>
                    </div>
                    <div class="status-bar">${stateTags || '<span>æ— çŠ¶æ€</span>'}</div>
                    <div class="log-area">${gameState.log.map(l=>`<div class="log-entry">${l}</div>`).join('')}</div>
                </div>
                <div class="right-col">
                    <div class="event-area">
                        <div class="event-title">${event.title}</div>
                        <div class="event-desc">${event.desc}</div>
                        <div class="option-buttons" id="vacationOptions">${optionsHtml}</div>
                    </div>
                    <div class="talent-view"><h4>âœ¨å¤©èµ‹</h4>${talentTags||'æ— '}</div>
                    <div class="talent-view"><h4>ğŸ†æˆå°±</h4>${achievementTags||'æ— '}</div>
                    <div class="detail-panel">${detailHtml}</div>
                </div>
            </div>
            <div class="control-bar"><button class="btn secondary" id="newGameBtn">è€å­ä¸å¹²äº†</button></div>
        `;
    }
    
    function attachVacationListeners() {
        document.querySelectorAll('#vacationOptions .option-btn').forEach(btn=>btn.addEventListener('click',e=>{
            let idx = e.target.dataset.optIndex;
            let vacEvents = VACATION_EVENTS[gameState.vacationType];
            let eventIdx = (gameState.vacationWeek-1) % vacEvents.length;
            let opt = vacEvents[eventIdx].options[idx];
            let eff = Array.isArray(opt.effects) ? opt.effects[Math.floor(Math.random()*opt.effects.length)] : opt.effects;
            for (let [k,v] of Object.entries(eff)) {
                if (k==='energy') gameState.stats.energy += v;
                else if (k==='funds') gameState.stats.funds += v;
                else if (k==='personalFunds') gameState.stats.personalFunds += v;
                else if (k in gameState.stats) gameState.stats[k] = Math.min(100, Math.max(-100, gameState.stats[k] + v));
            }
            addLog(`å‡æœŸï¼š${opt.text}`);
            if (gameState.vacationWeek >= 3) {
                if (confirm('å‡æœŸç»“æŸã€‚æ˜¯å¦ç»§ç»­å¸¦è¿™ä¸ªç­è¿›å…¥ä¸‹ä¸€å­¦æœŸï¼Ÿ')) {
                    let nextId = gameState.currentSemester.next;
                    if (nextId) {
                        let nextSem = SEMESTERS.find(s=>s.id===nextId);
                        gameState.currentSemester = nextSem;
                        gameState.week = 1; gameState.totalWeeks = nextSem.weeks;
                        gameState.gamePhase = 'playing';
                        gameState.stats.energy = gameState.stats.maxEnergy;
                        addLog(`è¿›å…¥${nextSem.label}`);
                    } else { gameState.gamePhase = 'ended'; }
                } else { gameState.gamePhase = 'ended'; }
            } else { gameState.vacationWeek++; }
            checkAchievements(); render();
        }));
        document.querySelectorAll('.status-item[data-state]').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'state',data:el.dataset.state}; render(); }));
        document.querySelectorAll('.achievement-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'achievement',data:el.dataset.achievement}; render(); }));
        document.querySelectorAll('.talent-tag').forEach(el=>el.addEventListener('click',()=>{ currentDetail={type:'talent',data:el.dataset.talent}; render(); }));
        document.getElementById('newGameBtn')?.addEventListener('click',()=>{ if(confirm('é‡æ–°å¼€å§‹ï¼Ÿ')) resetGame(); });
    }
    
    function renderEnding() {
        const s = gameState.stats;
        const score = Math.round(s.avgScore*0.3 + s.discipline*0.2 + s.hygiene*0.1 + s.cohesion*0.2 + s.rep*0.2);
        let grade = 'D';
        if (score >= 90) grade = 'S';
        else if (score >= 75) grade = 'A';
        else if (score >= 60) grade = 'B';
        else if (score >= 40) grade = 'C';
        return `
            <div class="header"><h2>ğŸ ç­ä¸»ä»»ç”Ÿæ¶¯ Â· ç»“å±€</h2></div>
            <div style="padding:30px; text-align:center">
                <div style="font-size:3rem; margin:20px 0; color:#2a1b4a">${grade}çº§</div>
                <div style="font-size:1.2rem; color:#3a2b5a">ç»¼åˆè¯„åˆ†: ${score}</div>
                <div style="margin:30px 0; color:#3a2b5a">å¸¦å®Œå­¦æœŸ: ${gameState.completedSemesters.length}</div>
                <div style="color:#3a2b5a">æˆå°±: ${gameState.achievements.map(a=>a.name).join(', ') || 'æ— '}</div>
                <button class="btn" id="newGameBtn" style="margin-top:30px">è€å­ä¸å¹²äº†</button>
            </div>
        `;
    }
    
    function attachEndingListeners() {
        document.getElementById('newGameBtn')?.addEventListener('click', resetGame);
    }
    
    function resetGame() {
        gameState = {
            semesterId: 'g1s1', classType: 'normal', subject: 'ç‰©ç†', personality: 'gentle', difficulty: 'normal',
            talents: [], currentSemester: null, week: 0, totalWeeks: 0, stats: { ...BASE_STATS }, log: [],
            gamePhase: 'setup', vacationWeek: 0, vacationType: 'summer', completedSemesters: [], skipWeek: false,
            playerStates: [], achievements: [],
        };
        currentDetail = { type: null, data: null };
        sessionStorage.removeItem('setupTalents');
        render();
    }
    
    render();
})();
</script>
</body>
</html>